<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å¤§åœ£è·‘é…· - åŠ¨æ€èƒŒæ™¯æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', 'Arial', sans-serif;
            background-color: #000;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }
        
        canvas {
            display: block;
            background-color: #0f3460;
            border: 2px solid #ffd700;
        }
        
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            z-index: 100;
            max-width: 300px;
        }
        
        .controls h3 {
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            z-index: 100;
            font-size: 14px;
            min-width: 200px;
        }
        
        .info h3 {
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .info-item {
            margin-bottom: 5px;
        }
        
        .btn {
            padding: 8px 16px;
            font-size: 14px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin: 5px 0;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        
        .game-stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            z-index: 100;
            min-width: 200px;
        }
        
        .game-stats h3 {
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>
    
    <div class="controls">
        <h3>ğŸ® æ¸¸æˆæ§åˆ¶</h3>
        <div class="control-group">
            <button id="startBtn" class="btn">å¼€å§‹æ¸¸æˆ</button>
        </div>
        <div class="control-group">
            <button id="pauseBtn" class="btn">æš‚åœæ¸¸æˆ</button>
        </div>
        <div class="control-group">
            <button id="resetBtn" class="btn">é‡ç½®æ¸¸æˆ</button>
        </div>
        
        <h3 style="margin-top: 15px;">ğŸŒ¤ï¸ èƒŒæ™¯æ§åˆ¶</h3>
        <div class="control-group">
            <label for="timeSpeed">æ—¶é—´æµé€Ÿ: <span id="timeSpeedValue">1</span></label>
            <input type="range" id="timeSpeed" min="0.1" max="3" step="0.1" value="1">
        </div>
        <div class="control-group">
            <label for="cloudSpeed">äº‘æœµé€Ÿåº¦: <span id="cloudSpeedValue">1</span></label>
            <input type="range" id="cloudSpeed" min="0" max="3" step="0.1" value="1">
        </div>
        <div class="control-group">
            <label for="mountainSpeed">è¿œå±±é€Ÿåº¦: <span id="mountainSpeedValue">1</span></label>
            <input type="range" id="mountainSpeed" min="0" max="3" step="0.1" value="1">
        </div>
        <div class="control-group">
            <label for="starTwinkle">æ˜Ÿæ˜Ÿé—ªçƒ: <span id="starTwinkleValue">1</span></label>
            <input type="range" id="starTwinkle" min="0" max="3" step="0.1" value="1">
        </div>
        
        <div class="control-group">
            <label>
                <input type="checkbox" id="showClouds" checked> æ˜¾ç¤ºäº‘æœµ
            </label>
        </div>
        <div class="control-group">
            <label>
                <input type="checkbox" id="showMountains" checked> æ˜¾ç¤ºè¿œå±±
            </label>
        </div>
        <div class="control-group">
            <label>
                <input type="checkbox" id="showStars" checked> æ˜¾ç¤ºæ˜Ÿæ˜Ÿ
            </label>
        </div>
    </div>
    
    <div class="info">
        <h3>ğŸŒ… èƒŒæ™¯ä¿¡æ¯</h3>
        <div class="info-item">æ—¶é—´å‘¨æœŸ: <span id="timeCycle">0.0</span>s</div>
        <div class="info-item">æ—¶é—´é˜¶æ®µ: <span id="timePhase">ç™½å¤©</span></div>
        <div class="info-item">äº‘æœµæ•°é‡: <span id="cloudCount">8</span></div>
        <div class="info-item">æ˜Ÿæ˜Ÿæ•°é‡: <span id="starCount">50</span></div>
        <div class="info-item">è¿œå±±æ•°é‡: <span id="mountainCount">3</span></div>
        <div class="info-item">èƒŒæ™¯å…ƒç´ : <span id="totalElements">61</span></div>
    </div>
    
    <div class="game-stats">
        <h3>ğŸ“Š æ¸¸æˆçŠ¶æ€</h3>
        <div class="stat-row">
            <span>åˆ†æ•°:</span>
            <span id="score">0</span>
        </div>
        <div class="stat-row">
            <span>é€Ÿåº¦:</span>
            <span id="speed">150</span> px/s
        </div>
        <div class="stat-row">
            <span>èƒ½é‡:</span>
            <span id="energy">0</span>/20
        </div>
        <div class="stat-row">
            <span>å†²åˆº:</span>
            <span id="dashing">å¦</span>
        </div>
        <div class="stat-row">
            <span>æ¸¸æˆæ—¶é—´:</span>
            <span id="gameTime">0.0</span>s
        </div>
        <div class="stat-row">
            <span>FPS:</span>
            <span id="fps">60</span>
        </div>
    </div>

    <script>
        // æ¸¸æˆå¸¸é‡
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const GAME_WIDTH = 800;
        const GAME_HEIGHT = 600;
        const PLAYER_WIDTH = 64;
        const PLAYER_HEIGHT = 64;
        const PLATFORM_WIDTH = 64;
        const PLATFORM_HEIGHT = 32;
        const PEACH_WIDTH = 32;
        const PEACH_HEIGHT = 32;
        const BIG_PEACH_WIDTH = 48;
        const BIG_PEACH_HEIGHT = 48;
        const GRAVITY = 500;
        const JUMP_FORCE = -350;
        const DOUBLE_JUMP_FORCE = -280;
        const MAX_FALL_SPEED = 400;
        const INITIAL_SPEED = 150;
        const MAX_SPEED = 350;
        const SPEED_UP_DURATION = 150;
        const DASH_SPEED = 500;
        const DASH_DURATION = 8;
        const DASH_COST = 20;
        const PEACH_SCORE = 1;
        const BIG_PEACH_SCORE = 5;
        
        // åŠ¨æ€èƒŒæ™¯é…ç½®
        const CLOUD_COUNT = 8;
        const STAR_COUNT = 50;
        const MOUNTAIN_COUNT = 3;
        const DAY_CYCLE_DURATION = 20; // 20ç§’ä¸€ä¸ªå®Œæ•´çš„æ˜¼å¤œå¾ªç¯
        
        // ç©å®¶çŠ¶æ€æšä¸¾
        const PLAYER_STATE = {
            IDLE: 'idle',
            RUNNING: 'running',
            JUMPING: 'jumping',
            DOUBLE_JUMPING: 'double_jumping',
            FALLING: 'falling',
            DASHING: 'dashing',
            DEAD: 'dead'
        };
        
        // æ§åˆ¶å‚æ•°
        let timeSpeedMultiplier = 1;
        let cloudSpeedMultiplier = 1;
        let mountainSpeedMultiplier = 1;
        let starTwinkleMultiplier = 1;
        let showClouds = true;
        let showMountains = true;
        let showStars = true;
        
        // æ¸¸æˆçŠ¶æ€
        let score = 0;
        let gameSpeed = INITIAL_SPEED;
        let isDashing = false;
        let dashEnergy = 0;
        let dashTimer = 0;
        let gameTime = 0;
        let lastUpdateTime = 0;
        let isGameOver = false;
        let isGamePaused = true;
        let isGameStarted = false;
        
        // æ€§èƒ½ç›‘æ§
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let currentFps = 60;
        
        // æ¸¸æˆå¯¹è±¡
        let player;
        let platforms = [];
        let peaches = [];
        let bigPeaches = [];
        
        // åŠ¨æ€èƒŒæ™¯å…ƒç´ 
        let clouds = [];
        let stars = [];
        let mountains = [];
        
        // å›¾ç‰‡èµ„æºï¼ˆä½¿ç”¨ç®€åŒ–çš„é¢œè‰²ä»£æ›¿å›¾ç‰‡ï¼‰
        const colors = {
            player: '#FFD700', // é‡‘è‰²
            platform: '#87CEEB', // å¤©è“è‰²
            peach: '#FF6347', // ç•ªèŒ„çº¢
            bigPeach: '#FF4500', // æ©™çº¢è‰²
            background: '#0f3460' // æ·±è“è‰²
        };
        
        // ç©å®¶ç±»
        class Player {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = PLAYER_WIDTH;
                this.height = PLAYER_HEIGHT;
                this.velocityX = 0;
                this.velocityY = 0;
                this.isOnGround = false;
                this.hasDoubleJumped = false;
                this.state = PLAYER_STATE.IDLE;
                this.animationFrame = 0;
                this.animationTime = 0;
                this.animationSpeed = 0.1;
            }
            
            update(deltaTime) {
                if (this.state === PLAYER_STATE.DEAD) return;
                
                // å†²åˆºæ—¶ä¸å—é‡åŠ›å½±å“ï¼Œä¿æŒé£è¡ŒçŠ¶æ€
                if (!isDashing) {
                    // åº”ç”¨é‡åŠ›
                    this.velocityY += GRAVITY * deltaTime;
                    if (this.velocityY > MAX_FALL_SPEED) {
                        this.velocityY = MAX_FALL_SPEED;
                    }
                } else {
                    // å†²åˆºæ—¶ä¿æŒåœ¨ç©ºä¸­ï¼Œè®¾ç½®ä¸€ä¸ªè½»å¾®çš„ä¸Šå‡åŠ›
                    this.velocityY = -20;
                }
                
                // æ›´æ–°ä½ç½®
                this.y += this.velocityY * deltaTime;
                
                // æ›´æ–°åŠ¨ç”»
                this.animationTime += deltaTime;
                if (this.animationTime >= this.animationSpeed) {
                    this.animationFrame = (this.animationFrame + 1) % 3;
                    this.animationTime = 0;
                }
                
                // æ›´æ–°çŠ¶æ€
                if (isDashing) {
                    this.state = PLAYER_STATE.DASHING;
                } else if (this.velocityY < 0) {
                    this.state = this.hasDoubleJumped ? PLAYER_STATE.DOUBLE_JUMPING : PLAYER_STATE.JUMPING;
                } else if (this.velocityY > 50) {
                    this.state = PLAYER_STATE.FALLING;
                } else if (this.isOnGround) {
                    this.state = PLAYER_STATE.RUNNING;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ‰è½ï¼ˆå†²åˆºæ—¶ä¸ä¼šæ‰è½ï¼‰
                if (!isDashing && this.y > GAME_HEIGHT) {
                    gameOver();
                }
            }
            
            draw() {
                ctx.save();
                
                // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
                let playerColor = colors.player;
                if (isDashing) {
                    // å†²åˆºæ—¶é—ªçƒé‡‘è‰²æ•ˆæœ
                    const flash = Math.floor(gameTime * 10) % 2;
                    playerColor = flash ? '#FFFF00' : '#FFD700';
                    ctx.shadowColor = '#FFFF00';
                    ctx.shadowBlur = 15;
                }
                
                // ç»˜åˆ¶ç©å®¶ï¼ˆä½¿ç”¨ç®€å•å›¾å½¢ä»£æ›¿å›¾ç‰‡ï¼‰
                ctx.fillStyle = playerColor;
                
                // æ ¹æ®åŠ¨ç”»å¸§ç»˜åˆ¶ä¸åŒå§¿æ€
                if (this.state === PLAYER_STATE.DASHING) {
                    // å†²åˆºå§¿æ€ - èº«ä½“å‰å€¾
                    ctx.beginPath();
                    ctx.ellipse(this.x + this.width/2, this.y + this.height/2, this.width*0.6, this.height*0.4, Math.PI/6, 0, Math.PI*2);
                    ctx.fill();
                } else if (this.velocityY !== 0) {
                    // è·³è·ƒ/ä¸‹è½å§¿æ€
                    ctx.beginPath();
                    ctx.ellipse(this.x + this.width/2, this.y + this.height/2, this.width*0.5, this.height*0.5, 0, 0, Math.PI*2);
                    ctx.fill();
                } else {
                    // ç«™ç«‹/è·‘æ­¥å§¿æ€
                    const runOffset = Math.sin(this.animationFrame * Math.PI/2) * 5;
                    ctx.fillRect(this.x + runOffset, this.y, this.width, this.height);
                }
                
                // ç»˜åˆ¶çœ¼ç›
                ctx.fillStyle = '#000';
                const eyeX = this.x + this.width * 0.7;
                const eyeY = this.y + this.height * 0.3;
                ctx.beginPath();
                ctx.arc(eyeX, eyeY, 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
            
            jump() {
                if (this.state === PLAYER_STATE.DEAD) return;
                
                if (this.isOnGround) {
                    // æ™®é€šè·³è·ƒ
                    this.velocityY = JUMP_FORCE;
                    this.isOnGround = false;
                    this.hasDoubleJumped = false;
                    return true;
                } else if (!this.hasDoubleJumped) {
                    // äºŒæ®µè·³
                    this.velocityY = DOUBLE_JUMP_FORCE;
                    this.hasDoubleJumped = true;
                    return true;
                }
                
                return false;
            }
            
            dash() {
                if (this.state === PLAYER_STATE.DEAD || isDashing || dashEnergy < DASH_COST) {
                    return false;
                }
                
                isDashing = true;
                dashTimer = DASH_DURATION;
                dashEnergy -= DASH_COST;
                
                // å†²åˆºæ—¶ä¸´æ—¶æé«˜æ¸¸æˆé€Ÿåº¦
                gameSpeed = DASH_SPEED;
                
                return true;
            }
        }
        
        // å¹³å°ç±»
        class Platform {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = PLATFORM_WIDTH;
                this.height = PLATFORM_HEIGHT;
            }
            
            update(deltaTime) {
                this.x -= gameSpeed * deltaTime;
            }
            
            draw() {
                ctx.fillStyle = colors.platform;
                
                // ç»˜åˆ¶äº‘æœµå¹³å°å½¢çŠ¶
                ctx.beginPath();
                ctx.arc(this.x + this.width/4, this.y + this.height/2, this.height/2, 0, Math.PI*2);
                ctx.arc(this.x + this.width*3/4, this.y + this.height/2, this.height/2, 0, Math.PI*2);
                ctx.rect(this.x, this.y + this.height/4, this.width, this.height/2);
                ctx.fill();
                
                // æ·»åŠ äº‘æœµçº¹ç†
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.beginPath();
                ctx.arc(this.x + this.width/3, this.y + this.height/3, this.height/6, 0, Math.PI*2);
                ctx.arc(this.x + this.width*2/3, this.y + this.height/3, this.height/6, 0, Math.PI*2);
                ctx.fill();
            }
        }
        
        // æ¡ƒå­ç±»
        class Peach {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = PEACH_WIDTH;
                this.height = PEACH_HEIGHT;
                this.animationTime = 0;
                this.animationSpeed = 0.02;
            }
            
            update(deltaTime) {
                this.x -= gameSpeed * deltaTime;
                this.animationTime += deltaTime;
            }
            
            draw() {
                const bounceOffset = Math.sin(this.animationTime * 10) * 2;
                
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2 + bounceOffset);
                
                // ç»˜åˆ¶æ¡ƒå­
                ctx.fillStyle = colors.peach;
                ctx.beginPath();
                ctx.arc(0, 0, this.width/2, 0, Math.PI*2);
                ctx.fill();
                
                // ç»˜åˆ¶æ¡ƒå­é¡¶éƒ¨
                ctx.fillStyle = '#32CD32';
                ctx.beginPath();
                ctx.arc(0, -this.height/3, this.width/6, 0, Math.PI*2);
                ctx.fill();
                
                // ç»˜åˆ¶å¶å­
                ctx.fillStyle = '#00FF00';
                ctx.beginPath();
                ctx.ellipse(0, -this.height/2, this.width/8, this.height/4, Math.PI/4, 0, Math.PI*2);
                ctx.fill();
                
                ctx.restore();
            }
            
            isOffScreen() {
                return this.x + this.width < 0;
            }
            
            checkCollision(player) {
                return (
                    player.x < this.x + this.width &&
                    player.x + player.width > this.x &&
                    player.y < this.y + this.height &&
                    player.y + player.height > this.y
                );
            }
        }
        
        // å¤§æ¡ƒå­ç±»
        class BigPeach {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = BIG_PEACH_WIDTH;
                this.height = BIG_PEACH_HEIGHT;
                this.animationTime = 0;
                this.animationSpeed = 0.015;
                this.rotation = 0;
            }
            
            update(deltaTime) {
                this.x -= gameSpeed * deltaTime;
                this.animationTime += deltaTime;
                this.rotation += 0.5 * deltaTime;
            }
            
            draw() {
                const bounceOffset = Math.sin(this.animationTime * 8) * 3;
                
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2 + bounceOffset);
                ctx.rotate(this.rotation);
                
                // æ·»åŠ å‘å…‰æ•ˆæœ
                ctx.shadowColor = '#FFFF00';
                ctx.shadowBlur = 10;
                
                // ç»˜åˆ¶å¤§æ¡ƒå­
                ctx.fillStyle = colors.bigPeach;
                ctx.beginPath();
                ctx.arc(0, 0, this.width/2, 0, Math.PI*2);
                ctx.fill();
                
                // ç»˜åˆ¶æ¡ƒå­é¡¶éƒ¨
                ctx.fillStyle = '#00FF00';
                ctx.beginPath();
                ctx.arc(0, -this.height/3, this.width/8, 0, Math.PI*2);
                ctx.fill();
                
                // ç»˜åˆ¶å¶å­
                ctx.fillStyle = '#32CD32';
                ctx.beginPath();
                ctx.ellipse(0, -this.height/2, this.width/10, this.height/5, Math.PI/3, 0, Math.PI*2);
                ctx.fill();
                
                // ç»˜åˆ¶é‡‘è‰²çº¹è·¯
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, this.width/3, 0, Math.PI*2, true);
                ctx.stroke();
                
                ctx.restore();
            }
            
            isOffScreen() {
                return this.x + this.width < 0;
            }
            
            checkCollision(player) {
                return (
                    player.x < this.x + this.width &&
                    player.x + player.width > this.x &&
                    player.y < this.y + this.height &&
                    player.y + player.height > this.y
                );
            }
        }
        
        // åˆå§‹åŒ–åŠ¨æ€èƒŒæ™¯
        function initBackground() {
            // åˆå§‹åŒ–äº‘æœµ - åˆ†å±‚è®¾è®¡
            clouds = [];
            for (let i = 0; i < CLOUD_COUNT; i++) {
                const layer = Math.floor(i / (CLOUD_COUNT / 3)); // åˆ†ä¸º3å±‚
                clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: Math.random() * (GAME_HEIGHT * 0.7), // äº‘æœµåªå‡ºç°åœ¨ä¸ŠåŠéƒ¨åˆ†
                    width: 80 + Math.random() * 60,
                    height: 40 + Math.random() * 20,
                    speed: 20 + Math.random() * 30 + (layer * 15), // ä¸Šå±‚äº‘æœµé€Ÿåº¦æ›´å¿«
                    opacity: 0.3 + Math.random() * 0.4 - (layer * 0.1), // ä¸Šå±‚äº‘æœµæ›´é€æ˜
                    layer: layer // è®°å½•äº‘å±‚
                });
            }
            
            // åˆå§‹åŒ–æ˜Ÿæ˜Ÿ - ä¸åŒå¤§å°å’Œäº®åº¦
            stars = [];
            for (let i = 0; i < STAR_COUNT; i++) {
                const size = 1 + Math.random() * 2;
                stars.push({
                    x: Math.random() * GAME_WIDTH,
                    y: Math.random() * GAME_HEIGHT,
                    size: size,
                    opacity: 0.5 + Math.random() * 0.5,
                    twinkleSpeed: 0.01 + Math.random() * 0.02,
                    twinklePhase: Math.random() * Math.PI * 2,
                    type: Math.random() < 0.7 ? 'circle' : 'cross' // 70%åœ†å½¢ï¼Œ30%åå­—å½¢
                });
            }
            
            // åˆå§‹åŒ–è¿œå±± - å¤šå±‚å±±è„‰
            mountains = [];
            for (let i = 0; i < MOUNTAIN_COUNT; i++) {
                const layer = i; // æ¯åº§å±±ä¸€ä¸ªå±‚
                mountains.push({
                    x: (i * GAME_WIDTH / MOUNTAIN_COUNT) + Math.random() * 100,
                    y: GAME_HEIGHT * 0.6 + Math.random() * GAME_HEIGHT * 0.2,
                    width: 300 + Math.random() * 200,
                    height: 150 + Math.random() * 100,
                    speed: 10 + Math.random() * 15 - (layer * 3), // åé¢çš„å±±ç§»åŠ¨æ›´æ…¢
                    opacity: 0.15 + Math.random() * 0.1 - (layer * 0.03), // åé¢çš„å±±æ›´é€æ˜
                    layer: layer // è®°å½•å±±å±‚
                });
            }
            
            // æŒ‰å±‚æ’åºï¼Œç¡®ä¿æ­£ç¡®çš„ç»˜åˆ¶é¡ºåº
            clouds.sort((a, b) => b.layer - a.layer); // ä¸Šå±‚äº‘æœµå…ˆç»˜åˆ¶
            mountains.sort((a, b) => b.layer - a.layer); // åé¢çš„å±±å…ˆç»˜åˆ¶
            
            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
            document.getElementById('cloudCount').textContent = CLOUD_COUNT;
            document.getElementById('starCount').textContent = STAR_COUNT;
            document.getElementById('mountainCount').textContent = MOUNTAIN_COUNT;
            document.getElementById('totalElements').textContent = CLOUD_COUNT + STAR_COUNT + MOUNTAIN_COUNT;
        }
        
        // æ›´æ–°åŠ¨æ€èƒŒæ™¯
        function updateBackground(deltaTime) {
            const scaledDeltaTime = deltaTime * timeSpeedMultiplier;
            const gameTimeOfDay = (gameTime % DAY_CYCLE_DURATION) / DAY_CYCLE_DURATION;
            
            // æ›´æ–°äº‘æœµä½ç½® - æ·»åŠ å¾®å¦™çš„å‚ç›´ç§»åŠ¨
            clouds.forEach(cloud => {
                cloud.x -= cloud.speed * scaledDeltaTime * cloudSpeedMultiplier;
                
                // å¾®å¦™çš„ä¸Šä¸‹æµ®åŠ¨æ•ˆæœ
                cloud.y += Math.sin(gameTime * 2 + cloud.x * 0.01) * 0.5 * scaledDeltaTime;
                
                // äº‘æœµç§»å‡ºå±å¹•åä»å³ä¾§é‡æ–°è¿›å…¥
                if (cloud.x + cloud.width < 0) {
                    cloud.x = GAME_WIDTH;
                    cloud.y = Math.random() * (GAME_HEIGHT * 0.7);
                    cloud.opacity = 0.3 + Math.random() * 0.4 - (cloud.layer * 0.1);
                }
            });
            
            // æ›´æ–°æ˜Ÿæ˜Ÿé—ªçƒ - æ›´è‡ªç„¶çš„é—ªçƒæ¨¡å¼
            stars.forEach(star => {
                // å¤œæ™šæ˜Ÿæ˜Ÿæ›´äº®ï¼Œç™½å¤©æ˜Ÿæ˜Ÿæ›´æš—
                const dayFactor = gameTimeOfDay < 0.5 ? 0.3 : 1;
                
                // å¤åˆæ³¢å½¢åˆ›é€ æ›´è‡ªç„¶çš„é—ªçƒ
                const baseTwinkle = Math.sin(star.twinklePhase);
                const secondaryTwinkle = Math.sin(star.twinklePhase * 0.3) * 0.3;
                const randomFactor = Math.random() * 0.1;
                
                star.twinklePhase += star.twinkleSpeed * starTwinkleMultiplier * scaledDeltaTime;
                star.opacity = (0.5 + 0.4 * baseTwinkle + 0.1 * secondaryTwinkle + randomFactor) * dayFactor;
                
                // é™åˆ¶é€æ˜åº¦èŒƒå›´
                star.opacity = Math.max(0.1, Math.min(1, star.opacity));
            });
            
            // æ›´æ–°è¿œå±±ä½ç½® - è§†å·®æ•ˆæœ
            mountains.forEach(mountain => {
                // è¿œå±±ç§»åŠ¨é€Ÿåº¦ä¸æ¸¸æˆé€Ÿåº¦ç›¸å…³
                const mountainSpeed = mountain.speed * (0.5 + gameSpeed / MAX_SPEED * 0.5);
                mountain.x -= mountainSpeed * scaledDeltaTime * mountainSpeedMultiplier;
                
                // è¿œå±±ç§»å‡ºå±å¹•åä»å³ä¾§é‡æ–°è¿›å…¥
                if (mountain.x + mountain.width < 0) {
                    mountain.x = GAME_WIDTH;
                    mountain.y = GAME_HEIGHT * 0.6 + Math.random() * GAME_HEIGHT * 0.2;
                    mountain.opacity = 0.15 + Math.random() * 0.1 - (mountain.layer * 0.03);
                }
            });
            
            // æ›´æ–°æ—¶é—´å‘¨æœŸæ˜¾ç¤º
            const currentCycle = gameTime % DAY_CYCLE_DURATION;
            document.getElementById('timeCycle').textContent = currentCycle.toFixed(1);
            
            // æ›´æ–°æ—¶é—´é˜¶æ®µæ˜¾ç¤º
            let timePhase = 'ç™½å¤©';
            if (gameTimeOfDay >= 0.4 && gameTimeOfDay <= 0.6) {
                timePhase = 'é»„æ˜/é»æ˜';
            } else if (gameTimeOfDay > 0.5) {
                timePhase = 'å¤œæ™š';
            }
            document.getElementById('timePhase').textContent = timePhase;
        }
        
        // ç»˜åˆ¶äº‘æœµå½¢çŠ¶ - ä½¿ç”¨æ›´è‡ªç„¶çš„äº‘æœµè½®å»“
        function drawCloud(ctx, x, y, width, height) {
            ctx.beginPath();
            
            // ä½¿ç”¨å¤šä¸ªåœ†å½¢ç»„åˆæˆäº‘æœµå½¢çŠ¶
            const centerY = y + height * 0.4; // äº‘æœµä¸­å¿ƒåä¸Š
            const radius = height * 0.4;
            
            // ä¸»è¦äº‘æœµéƒ¨åˆ†
            ctx.arc(x + width * 0.25, centerY, radius, 0, Math.PI * 2);
            ctx.arc(x + width * 0.5, centerY - radius * 0.2, radius * 0.9, 0, Math.PI * 2);
            ctx.arc(x + width * 0.75, centerY, radius, 0, Math.PI * 2);
            ctx.arc(x + width * 0.4, centerY + radius * 0.3, radius * 0.7, 0, Math.PI * 2);
            ctx.arc(x + width * 0.65, centerY + radius * 0.2, radius * 0.6, 0, Math.PI * 2);
            
            // äº‘æœµåº•éƒ¨
            ctx.rect(x, centerY + radius * 0.3, width, height * 0.3);
            
            ctx.fill();
        }
        
        // ç»˜åˆ¶åŠ¨æ€èƒŒæ™¯
        function drawBackground() {
            const gameTimeOfDay = (gameTime % DAY_CYCLE_DURATION) / DAY_CYCLE_DURATION;
            
            // ç»˜åˆ¶æ¸å˜å¤©ç©ºèƒŒæ™¯ - æ ¹æ®æ¸¸æˆæ—¶é—´å˜åŒ–é¢œè‰²
            const gradient = ctx.createLinearGradient(0, 0, 0, GAME_HEIGHT);
            
            // æ ¹æ®æ—¶é—´è°ƒæ•´èƒŒæ™¯é¢œè‰²
            if (gameTimeOfDay < 0.5) {
                // ç™½å¤©æ•ˆæœ - è“è‰²ç³»
                const intensity = 1 - Math.abs(gameTimeOfDay - 0.25) * 4; // ä¸­é—´æœ€äº®
                const blueTop = Math.floor(15 + intensity * 20); // #0f3460 åˆ° #194970
                const blueBottom = Math.floor(22 + intensity * 25); // #16213e åˆ° #1e2e50
                
                gradient.addColorStop(0, `rgb(15, ${blueTop}, 96)`); // æ·±è“è‰²å¤©ç©ºé¡¶éƒ¨
                gradient.addColorStop(1, `rgb(22, 33, ${blueBottom})`); // ç¨æµ…çš„è“è‰²åº•éƒ¨
            } else {
                // é»„æ˜/å¤œæ™šæ•ˆæœ - ç´«è‰²ç³»
                const intensity = Math.abs(gameTimeOfDay - 0.75) * 4; // è¾¹ç¼˜æœ€æš—
                const purpleTop = Math.floor(20 + intensity * 15); // #14142e åˆ° #1e2345
                const purpleBottom = Math.floor(25 + intensity * 20); // #0f1429 åˆ° #161d3a
                
                gradient.addColorStop(0, `rgb(20, 20, ${purpleTop})`); // ç´«è‰²å¤©ç©ºé¡¶éƒ¨
                gradient.addColorStop(1, `rgb(15, 20, ${purpleBottom})`); // æ·±ç´«è‰²åº•éƒ¨
            }
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            // ç»˜åˆ¶è¿œå±± - ä½¿ç”¨æ›´è‡ªç„¶çš„å½¢çŠ¶
            if (showMountains) {
                mountains.forEach(mountain => {
                    ctx.globalAlpha = mountain.opacity;
                    
                    // æ ¹æ®æ—¶é—´è°ƒæ•´å±±çš„é¢œè‰²
                    if (gameTimeOfDay < 0.5) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)'; // ç™½å¤©
                    } else {
                        ctx.fillStyle = 'rgba(20, 20, 40, 0.3)'; // å¤œæ™š
                    }
                    
                    ctx.beginPath();
                    
                    // ç»˜åˆ¶é”¯é½¿çŠ¶å±±è„‰è½®å»“
                    ctx.moveTo(mountain.x, mountain.y);
                    
                    // ç”Ÿæˆå¤šä¸ªå±±å³°
                    const peakCount = 3 + Math.floor(mountain.width / 100);
                    for (let i = 0; i <= peakCount; i++) {
                        const peakX = mountain.x + (i * mountain.width / peakCount);
                        const peakHeight = mountain.height * (0.5 + Math.sin(i * 1.5 + mountain.x * 0.01) * 0.5);
                        ctx.lineTo(peakX, mountain.y - peakHeight);
                    }
                    
                    ctx.lineTo(mountain.x + mountain.width, mountain.y);
                    ctx.closePath();
                    ctx.fill();
                });
            }
            
            // ç»˜åˆ¶æ˜Ÿæ˜Ÿ - å¤œæ™šæ˜Ÿæ˜Ÿæ›´äº®
            if (showStars) {
                const starBrightness = gameTimeOfDay > 0.5 ? 1 : 0.3; // å¤œæ™šæ˜Ÿæ˜Ÿæ›´äº®
                stars.forEach(star => {
                    const finalOpacity = star.opacity * starBrightness;
                    if (finalOpacity > 0.1) { // äº®åº¦å¤ªä½çš„æ˜Ÿæ˜Ÿä¸æ˜¾ç¤º
                        ctx.globalAlpha = finalOpacity;
                        
                        // æ ¹æ®æ˜Ÿæ˜Ÿç±»å‹ç»˜åˆ¶
                        if (star.type === 'circle') {
                            // åœ†å½¢æ˜Ÿæ˜Ÿ
                            ctx.fillStyle = 'white';
                            ctx.beginPath();
                            ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // æ·»åŠ å…‰æ™•æ•ˆæœ
                            if (star.size > 1.5 && Math.random() < 0.3) {
                                ctx.globalAlpha = finalOpacity * 0.3;
                                ctx.beginPath();
                                ctx.arc(star.x, star.y, star.size * 2, 0, Math.PI * 2);
                                ctx.fill();
                            }
                        } else {
                            // åå­—å½¢æ˜Ÿæ˜Ÿ
                            ctx.strokeStyle = 'white';
                            ctx.lineWidth = star.size * 0.5;
                            ctx.beginPath();
                            ctx.moveTo(star.x - star.size, star.y);
                            ctx.lineTo(star.x + star.size, star.y);
                            ctx.moveTo(star.x, star.y - star.size);
                            ctx.lineTo(star.x, star.y + star.size);
                            ctx.stroke();
                        }
                    }
                });
            }
            
            // ç»˜åˆ¶äº‘æœµ - ç™½å¤©äº‘æœµæ›´æ˜æ˜¾
            if (showClouds) {
                const cloudOpacity = gameTimeOfDay < 0.5 ? 1 : 0.5; // å¤œæ™šäº‘æœµè¾ƒæš—
                clouds.forEach(cloud => {
                    const finalOpacity = cloud.opacity * cloudOpacity;
                    if (finalOpacity > 0.1) { // é€æ˜åº¦å¤ªä½çš„äº‘æœµä¸æ˜¾ç¤º
                        ctx.globalAlpha = finalOpacity;
                        
                        // æ ¹æ®æ—¶é—´è°ƒæ•´äº‘æœµé¢œè‰²
                        if (gameTimeOfDay < 0.5) {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)'; // ç™½å¤©ç™½è‰²äº‘æœµ
                        } else {
                            ctx.fillStyle = 'rgba(40, 40, 60, 0.8)'; // å¤œæ™šæš—ç°è‰²äº‘æœµ
                        }
                        
                        drawCloud(ctx, cloud.x, cloud.y, cloud.width, cloud.height);
                        
                        // æ·»åŠ äº‘æœµè¾¹ç¼˜å…‰æ™•æ•ˆæœ
                        if (gameTimeOfDay < 0.5 && Math.random() < 0.3) {
                            ctx.globalAlpha = finalOpacity * 0.2;
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                            drawCloud(ctx, cloud.x - 5, cloud.y - 5, cloud.width + 10, cloud.height + 10);
                        }
                    }
                });
            }
            
            // é‡ç½®é€æ˜åº¦
            ctx.globalAlpha = 1;
            
            // æ·»åŠ å¤§æ°”è¾‰å…‰æ•ˆæœ
            if (gameTimeOfDay > 0.4 && gameTimeOfDay < 0.6) {
                // é»„æ˜/é»æ˜æ—¶åˆ†çš„è¾‰å…‰
                const glowIntensity = Math.abs(0.5 - gameTimeOfDay) * 20;
                const gradient = ctx.createRadialGradient(
                    GAME_WIDTH / 2, GAME_HEIGHT / 2, 0,
                    GAME_WIDTH / 2, GAME_HEIGHT / 2, GAME_WIDTH
                );
                gradient.addColorStop(0, `rgba(255, 165, 0, ${glowIntensity * 0.01})`);
                gradient.addColorStop(1, 'rgba(255, 165, 0, 0)');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            }
        }
        
        // ç”Ÿæˆåˆå§‹å¹³å°
        function generateInitialPlatforms() {
            platforms = [];
            
            // ä»å±å¹•åº•éƒ¨å¼€å§‹ç”Ÿæˆå¹³å°
            let y = GAME_HEIGHT - PLATFORM_HEIGHT - 50;
            let x = GAME_WIDTH / 2;
            
            // ç”Ÿæˆèµ·å§‹å¹³å°
            platforms.push(new Platform(x, y));
            
            // å‘ä¸Šç”Ÿæˆä¸€ç³»åˆ—å¹³å°
            for (let i = 0; i < 10; i++) {
                // éšæœºç”Ÿæˆä¸‹ä¸€ä¸ªå¹³å°çš„ä½ç½®
                const dx = (Math.random() - 0.5) * 200; // å·¦å³åç§»
                const dy = -80 - Math.random() * 60; // å‘ä¸Šåç§»ï¼Œæœ‰ä¸€å®šéšæœºæ€§
                
                x += dx;
                y += dy;
                
                // ç¡®ä¿å¹³å°åœ¨å±å¹•èŒƒå›´å†…
                if (x < PLATFORM_WIDTH) x = PLATFORM_WIDTH;
                if (x > GAME_WIDTH - PLATFORM_WIDTH) x = GAME_WIDTH - PLATFORM_WIDTH;
                if (y < PLATFORM_HEIGHT) y = PLATFORM_HEIGHT;
                
                platforms.push(new Platform(x, y));
            }
        }
        
        // ç”Ÿæˆæ–°å¹³å°
        function generatePlatform() {
            // ä»ä¸Šä¸€ä¸ªå¹³å°çš„ä½ç½®ç”Ÿæˆæ–°å¹³å°
            const lastPlatform = platforms[platforms.length - 1];
            
            // éšæœºç”Ÿæˆä¸‹ä¸€ä¸ªå¹³å°çš„ä½ç½®
            const dx = (Math.random() - 0.5) * 200; // å·¦å³åç§»
            const dy = -80 - Math.random() * 60; // å‘ä¸Šåç§»ï¼Œæœ‰ä¸€å®šéšæœºæ€§
            
            let x = lastPlatform.x + dx;
            let y = lastPlatform.y + dy;
            
            // ç¡®ä¿å¹³å°åœ¨å±å¹•èŒƒå›´å†…
            if (x < PLATFORM_WIDTH) x = PLATFORM_WIDTH;
            if (x > GAME_WIDTH - PLATFORM_WIDTH) x = GAME_WIDTH - PLATFORM_WIDTH;
            if (y < PLATFORM_HEIGHT) y = PLATFORM_HEIGHT;
            
            platforms.push(new Platform(x, y));
            
            // éšæœºç”Ÿæˆæ¡ƒå­
            if (Math.random() < 0.7) {
                const peachX = x + (Math.random() * (PLATFORM_WIDTH - PEACH_WIDTH));
                const peachY = y - PEACH_HEIGHT - 5;
                peaches.push(new Peach(peachX, peachY));
            }
            
            // éšæœºç”Ÿæˆå¤§æ¡ƒå­ï¼ˆæ¦‚ç‡è¾ƒä½ï¼‰
            if (Math.random() < 0.1) {
                const bigPeachX = x + (Math.random() * (PLATFORM_WIDTH - BIG_PEACH_WIDTH));
                const bigPeachY = y - BIG_PEACH_HEIGHT - 5;
                bigPeaches.push(new BigPeach(bigPeachX, bigPeachY));
            }
        }
        
        // æ›´æ–°å¹³å°
        function updatePlatforms(deltaTime) {
            // æ›´æ–°æ‰€æœ‰å¹³å°ä½ç½®
            platforms.forEach(platform => {
                platform.update(deltaTime);
            });
            
            // ç§»é™¤ç¦»å¼€å±å¹•çš„å¹³å°
            platforms = platforms.filter(platform => platform.x + platform.width > 0);
            
            // å¦‚æœæœ€åä¸€ä¸ªå¹³å°æ¥è¿‘å±å¹•å³ä¾§ï¼Œç”Ÿæˆæ–°å¹³å°
            if (platforms.length > 0) {
                const lastPlatform = platforms[platforms.length - 1];
                if (lastPlatform.x + lastPlatform.width < GAME_WIDTH + 200) {
                    generatePlatform();
                }
            }
        }
        
        // æ›´æ–°æ¡ƒå­
        function updatePeaches(deltaTime) {
            // æ›´æ–°æ‰€æœ‰æ¡ƒå­ä½ç½®
            peaches.forEach(peach => {
                peach.update(deltaTime);
            });
            
            bigPeaches.forEach(bigPeach => {
                bigPeach.update(deltaTime);
            });
            
            // ç§»é™¤ç¦»å¼€å±å¹•çš„æ¡ƒå­
            peaches = peaches.filter(peach => !peach.isOffScreen());
            bigPeaches = bigPeaches.filter(bigPeach => !bigPeach.isOffScreen());
        }
        
        // æ›´æ–°æ¸¸æˆé€Ÿåº¦
        function updateGameSpeed(deltaTime) {
            // æ¸¸æˆé€Ÿåº¦éšæ—¶é—´é€æ¸å¢åŠ 
            if (!isDashing && gameSpeed < MAX_SPEED) {
                const speedIncrease = (MAX_SPEED - INITIAL_SPEED) / SPEED_UP_DURATION;
                gameSpeed += speedIncrease * deltaTime;
                if (gameSpeed > MAX_SPEED) {
                    gameSpeed = MAX_SPEED;
                }
            }
        }
        
        // æ›´æ–°å†²åˆºçŠ¶æ€
        function updateDash(deltaTime) {
            if (isDashing) {
                dashTimer -= deltaTime;
                if (dashTimer <= 0) {
                    isDashing = false;
                    dashTimer = 0;
                    // å†²åˆºç»“æŸåæ¢å¤æ­£å¸¸é€Ÿåº¦
                    gameSpeed = Math.min(gameSpeed, MAX_SPEED);
                }
            }
        }
        
        // æ£€æµ‹ç¢°æ’
        function checkCollisions() {
            // å¹³å°ç¢°æ’
            player.isOnGround = false;
            
            // å†²åˆºæ—¶ä¸è¿›è¡Œå¹³å°ç¢°æ’æ£€æµ‹ï¼Œå®ç°æ— æ•Œé£è¡Œ
            if (!isDashing) {
                // ä½¿ç”¨è¾¹ç•Œæ¡†ä¼˜åŒ–ç¢°æ’æ£€æµ‹
                const playerBottom = player.y + player.height;
                const playerRight = player.x + player.width;
                
                // åªæ£€æŸ¥å±å¹•å†…çš„å¹³å°
                for (let i = 0; i < platforms.length; i++) {
                    const platform = platforms[i];
                    
                    // å¿«é€Ÿæ’é™¤æ˜æ˜¾ä¸ç¢°æ’çš„æƒ…å†µ
                    if (playerRight < platform.x || player.x > platform.x + platform.width) {
                        continue;
                    }
                    
                    if (
                        playerRight > platform.x &&
                        player.x < platform.x + platform.width &&
                        playerBottom > platform.y &&
                        playerBottom < platform.y + 20 &&
                        player.velocityY > 0
                    ) {
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.isOnGround = true;
                        player.hasDoubleJumped = false;
                        break; // åªå¤„ç†ä¸€ä¸ªå¹³å°ç¢°æ’
                    }
                }
            }
            
            // æ¡ƒå­ç¢°æ’
            let collectedPeaches = 0;
            let collectedBigPeaches = 0;
            
            // å°æ¡ƒå­ç¢°æ’æ£€æµ‹
            for (let i = peaches.length - 1; i >= 0; i--) {
                if (peaches[i].checkCollision(player)) {
                    peaches.splice(i, 1);
                    collectedPeaches++;
                }
            }
            
            // å¤§æ¡ƒå­ç¢°æ’æ£€æµ‹
            for (let i = bigPeaches.length - 1; i >= 0; i--) {
                if (bigPeaches[i].checkCollision(player)) {
                    bigPeaches.splice(i, 1);
                    collectedBigPeaches++;
                }
            }
            
            // æ‰¹é‡æ›´æ–°åˆ†æ•°å’Œèƒ½é‡
            if (collectedPeaches > 0 || collectedBigPeaches > 0) {
                // å†²åˆºæ—¶èŸ æ¡ƒæ•°é‡å¢åŠ ä¸‰å€
                const scoreMultiplier = isDashing ? 3 : 1;
                
                const totalScore = (collectedPeaches * PEACH_SCORE + collectedBigPeaches * BIG_PEACH_SCORE) * scoreMultiplier;
                const totalEnergy = (collectedPeaches * PEACH_SCORE + collectedBigPeaches * BIG_PEACH_SCORE) * scoreMultiplier;
                
                score += totalScore;
                dashEnergy += totalEnergy;
                
                // èƒ½é‡ä¸Šé™ä¸ºDASH_COST
                if (dashEnergy > DASH_COST) {
                    dashEnergy = DASH_COST;
                }
            }
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver() {
            isGameOver = true;
            isGamePaused = true;
            player.state = PLAYER_STATE.DEAD;
        }
        
        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            score = 0;
            gameSpeed = INITIAL_SPEED;
            isDashing = false;
            dashEnergy = 0;
            dashTimer = 0;
            gameTime = 0;
            isGameOver = false;
            isGamePaused = true;
            isGameStarted = false;
            
            // é‡ç½®ç©å®¶
            player = new Player(GAME_WIDTH / 4, GAME_HEIGHT / 2);
            
            // é‡ç½®å¹³å°å’Œæ¡ƒå­
            platforms = [];
            peaches = [];
            bigPeaches = [];
            
            // ç”Ÿæˆåˆå§‹å¹³å°
            generateInitialPlatforms();
            
            // é‡ç½®åŠ¨æ€èƒŒæ™¯
            initBackground();
            
            // æ›´æ–°UI
            updateUI();
        }
        
        // æ›´æ–°UIæ˜¾ç¤º
        function updateUI() {
            document.getElementById('score').textContent = Math.floor(score);
            document.getElementById('speed').textContent = Math.floor(gameSpeed);
            document.getElementById('energy').textContent = Math.floor(dashEnergy);
            document.getElementById('dashing').textContent = isDashing ? 'æ˜¯' : 'å¦';
            document.getElementById('gameTime').textContent = gameTime.toFixed(1);
            document.getElementById('fps').textContent = currentFps;
        }
        
        // æ¸²æŸ“æ¸¸æˆ
        function renderGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            // ç»˜åˆ¶åŠ¨æ€èƒŒæ™¯
            drawBackground();
            
            // ç»˜åˆ¶å¹³å°
            platforms.forEach(platform => {
                platform.draw();
            });
            
            // ç»˜åˆ¶æ¡ƒå­
            peaches.forEach(peach => {
                peach.draw();
            });
            
            bigPeaches.forEach(bigPeach => {
                bigPeach.draw();
            });
            
            // ç»˜åˆ¶ç©å®¶
            player.draw();
            
            // ç»˜åˆ¶UIå…ƒç´ 
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.fillText(`åˆ†æ•°: ${Math.floor(score)}`, 20, 30);
            
            // ç»˜åˆ¶èƒ½é‡æ¡
            const energyBarWidth = 200;
            const energyBarHeight = 15;
            const energyBarX = 20;
            const energyBarY = 50;
            
            // èƒ½é‡æ¡èƒŒæ™¯
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.fillRect(energyBarX, energyBarY, energyBarWidth, energyBarHeight);
            
            // èƒ½é‡æ¡å¡«å……
            const energyPercentage = dashEnergy / DASH_COST;
            const gradient = ctx.createLinearGradient(energyBarX, energyBarY, energyBarX + energyBarWidth, energyBarY);
            gradient.addColorStop(0, '#FFD700');
            gradient.addColorStop(1, '#FFA500');
            ctx.fillStyle = gradient;
            ctx.fillRect(energyBarX, energyBarY, energyBarWidth * energyPercentage, energyBarHeight);
            
            // èƒ½é‡æ¡æ–‡å­—
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.fillText(`ç­‹æ–—äº‘èƒ½é‡: ${Math.floor(dashEnergy)}/${DASH_COST}`, energyBarX, energyBarY - 5);
            
            // ç»˜åˆ¶å†²åˆºçŠ¶æ€
            if (isDashing) {
                ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
                ctx.font = 'bold 24px Arial';
                ctx.fillText('ç­‹æ–—äº‘å†²åˆºä¸­!', GAME_WIDTH - 220, 40);
                
                // ç»˜åˆ¶å†²åˆºå€’è®¡æ—¶
                const dashTimeLeft = Math.ceil(dashTimer);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.font = '18px Arial';
                ctx.fillText(`å‰©ä½™æ—¶é—´: ${dashTimeLeft}s`, GAME_WIDTH - 220, 70);
            }
            
            // ç»˜åˆ¶æš‚åœ/å¼€å§‹æç¤º
            if (isGamePaused && !isGameOver) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(isGameStarted ? 'æ¸¸æˆæš‚åœ' : 'ç‚¹å‡»å¼€å§‹æ¸¸æˆ', GAME_WIDTH / 2, GAME_HEIGHT / 2 - 50);
                
                ctx.font = '24px Arial';
                ctx.fillText('ç‚¹å‡»å±å¹•è·³è·ƒï¼Œå†æ¬¡ç‚¹å‡»äºŒæ®µè·³', GAME_WIDTH / 2, GAME_HEIGHT / 2 + 20);
                ctx.fillText('ç©ºæ ¼é”®ä½¿ç”¨ç­‹æ–—äº‘å†²åˆº', GAME_WIDTH / 2, GAME_HEIGHT / 2 + 60);
                
                ctx.textAlign = 'left'; // é‡ç½®æ–‡æœ¬å¯¹é½
            }
            
            // ç»˜åˆ¶æ¸¸æˆç»“æŸç”»é¢
            if (isGameOver) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                
                ctx.fillStyle = 'red';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ¸¸æˆç»“æŸ', GAME_WIDTH / 2, GAME_HEIGHT / 2 - 80);
                
                ctx.fillStyle = 'white';
                ctx.font = '36px Arial';
                ctx.fillText(`æœ€ç»ˆå¾—åˆ†: ${Math.floor(score)}`, GAME_WIDTH / 2, GAME_HEIGHT / 2 - 20);
                
                ctx.font = '24px Arial';
                ctx.fillText('ç‚¹å‡»é‡ç½®æŒ‰é’®é‡æ–°å¼€å§‹', GAME_WIDTH / 2, GAME_HEIGHT / 2 + 40);
                
                ctx.textAlign = 'left'; // é‡ç½®æ–‡æœ¬å¯¹é½
            }
        }
        
        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            const currentTime = performance.now();
            const deltaTime = (currentTime - lastUpdateTime) / 1000; // è½¬æ¢ä¸ºç§’
            lastUpdateTime = currentTime;
            
            // æ›´æ–°FPS
            frameCount++;
            if (currentTime - lastFpsUpdate >= 1000) {
                currentFps = Math.round(frameCount * 1000 / (currentTime - lastFpsUpdate));
                frameCount = 0;
                lastFpsUpdate = currentTime;
            }
            
            if (!isGamePaused && !isGameOver && isGameStarted) {
                gameTime += deltaTime;
                
                // æ›´æ–°åŠ¨æ€èƒŒæ™¯
                updateBackground(deltaTime);
                
                // æ›´æ–°æ¸¸æˆé€Ÿåº¦
                updateGameSpeed(deltaTime);
                
                // æ›´æ–°ç©å®¶
                player.update(deltaTime);
                
                // æ›´æ–°å¹³å°
                updatePlatforms(deltaTime);
                
                // æ›´æ–°æ¡ƒå­
                updatePeaches(deltaTime);
                
                // æ›´æ–°å†²åˆºçŠ¶æ€
                updateDash(deltaTime);
                
                // æ£€æµ‹ç¢°æ’
                checkCollisions();
            }
            
            // æ¸²æŸ“æ¸¸æˆ
            renderGame();
            
            // æ›´æ–°UI
            updateUI();
            
            // ç»§ç»­æ¸¸æˆå¾ªç¯
            requestAnimationFrame(gameLoop);
        }
        
        // åˆå§‹åŒ–æ§åˆ¶äº‹ä»¶
        function initControls() {
            // æ—¶é—´æµé€Ÿæ§åˆ¶
            const timeSpeedSlider = document.getElementById('timeSpeed');
            const timeSpeedValue = document.getElementById('timeSpeedValue');
            timeSpeedSlider.addEventListener('input', function() {
                timeSpeedMultiplier = parseFloat(this.value);
                timeSpeedValue.textContent = timeSpeedMultiplier.toFixed(1);
            });
            
            // äº‘æœµé€Ÿåº¦æ§åˆ¶
            const cloudSpeedSlider = document.getElementById('cloudSpeed');
            const cloudSpeedValue = document.getElementById('cloudSpeedValue');
            cloudSpeedSlider.addEventListener('input', function() {
                cloudSpeedMultiplier = parseFloat(this.value);
                cloudSpeedValue.textContent = cloudSpeedMultiplier.toFixed(1);
            });
            
            // è¿œå±±é€Ÿåº¦æ§åˆ¶
            const mountainSpeedSlider = document.getElementById('mountainSpeed');
            const mountainSpeedValue = document.getElementById('mountainSpeedValue');
            mountainSpeedSlider.addEventListener('input', function() {
                mountainSpeedMultiplier = parseFloat(this.value);
                mountainSpeedValue.textContent = mountainSpeedMultiplier.toFixed(1);
            });
            
            // æ˜Ÿæ˜Ÿé—ªçƒæ§åˆ¶
            const starTwinkleSlider = document.getElementById('starTwinkle');
            const starTwinkleValue = document.getElementById('starTwinkleValue');
            starTwinkleSlider.addEventListener('input', function() {
                starTwinkleMultiplier = parseFloat(this.value);
                starTwinkleValue.textContent = starTwinkleMultiplier.toFixed(1);
            });
            
            // æ˜¾ç¤º/éšè—äº‘æœµ
            const showCloudsCheckbox = document.getElementById('showClouds');
            showCloudsCheckbox.addEventListener('change', function() {
                showClouds = this.checked;
            });
            
            // æ˜¾ç¤º/éšè—è¿œå±±
            const showMountainsCheckbox = document.getElementById('showMountains');
            showMountainsCheckbox.addEventListener('change', function() {
                showMountains = this.checked;
            });
            
            // æ˜¾ç¤º/éšè—æ˜Ÿæ˜Ÿ
            const showStarsCheckbox = document.getElementById('showStars');
            showStarsCheckbox.addEventListener('change', function() {
                showStars = this.checked;
            });
            
            // å¼€å§‹æ¸¸æˆ
            const startBtn = document.getElementById('startBtn');
            startBtn.addEventListener('click', function() {
                if (!isGameStarted) {
                    isGameStarted = true;
                }
                isGamePaused = false;
            });
            
            // æš‚åœæ¸¸æˆ
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.addEventListener('click', function() {
                if (isGameStarted && !isGameOver) {
                    isGamePaused = !isGamePaused;
                }
            });
            
            // é‡ç½®æ¸¸æˆ
            const resetBtn = document.getElementById('resetBtn');
            resetBtn.addEventListener('click', function() {
                resetGame();
            });
            
            // é”®ç›˜æ§åˆ¶
            document.addEventListener('keydown', function(event) {
                if (event.code === 'Space') {
                    event.preventDefault();
                    
                    if (isGamePaused && !isGameOver) {
                        if (!isGameStarted) {
                            isGameStarted = true;
                        }
                        isGamePaused = false;
                    } else if (!isGamePaused && isGameStarted) {
                        if (dashEnergy >= DASH_COST && !isDashing) {
                            player.dash();
                        } else {
                            player.jump();
                        }
                    }
                } else if (event.code === 'Escape') {
                    if (isGameStarted && !isGameOver) {
                        isGamePaused = !isGamePaused;
                    }
                }
            });
            
            // è§¦æ‘¸/é¼ æ ‡æ§åˆ¶
            canvas.addEventListener('click', function() {
                if (isGamePaused && !isGameOver) {
                    if (!isGameStarted) {
                        isGameStarted = true;
                    }
                    isGamePaused = false;
                } else if (!isGamePaused && isGameStarted) {
                    if (dashEnergy >= DASH_COST && !isDashing) {
                        player.dash();
                    } else {
                        player.jump();
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function init() {
            // åˆå§‹åŒ–ç©å®¶
            player = new Player(GAME_WIDTH / 4, GAME_HEIGHT / 2);
            
            // ç”Ÿæˆåˆå§‹å¹³å°
            generateInitialPlatforms();
            
            // åˆå§‹åŒ–åŠ¨æ€èƒŒæ™¯
            initBackground();
            
            // åˆå§‹åŒ–æ§åˆ¶
            initControls();
            
            // è®¾ç½®æ¸¸æˆå¾ªç¯
            lastUpdateTime = performance.now();
            lastFpsUpdate = lastUpdateTime;
            gameLoop();
        }
        
        // å¯åŠ¨æ¸¸æˆ
        init();
    </script>
</body>
</html>