<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å¤§åœ£è·‘é…· - äº‘ç«¯å†’é™©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', 'Arial', sans-serif;
            background-color: #000;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            margin: 0;
            padding: 0;
        }
        
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }
        
        canvas {
            display: block;
            background-color: #0f3460;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 100;
            overflow: hidden;
        }
        
        .screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/d712908c0657488694fcece2e91b8e27.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251211151321B21EE154840ADF8FD029&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1766042001&x-signature=msO1OkLPQywBN4e6L9bYfMLzkx8%3D');
            background-size: cover;
            background-position: center;
            opacity: 0.2;
            z-index: -1;
        }
        
        .screen-content {
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.5s ease-out;
            color: white;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h1 {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            font-weight: bold;
            letter-spacing: 2px;
        }
        
        h2 {
            font-size: 32px;
            margin-bottom: 25px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        p {
            font-size: 18px;
            margin-bottom: 25px;
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: hidden;
            margin: 10px 0;
            min-width: 180px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }
        
        .btn-secondary {
            padding: 15px 30px;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
            backdrop-filter: blur(5px);
            min-width: 180px;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #FFA500;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .main-menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
            align-items: center;
            width: 100%;
        }
        
        .main-menu-buttons .btn,
        .main-menu-buttons .btn-secondary {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            margin: 0;
        }
        
        .settings-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 30px 0;
            width: 300px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2196F3;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .settings-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }
        
        ul {
            text-align: left;
            margin: 15px 0;
            padding-left: 20px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .hud-left {
            flex: 1;
            text-align: left;
        }
        
        .hud-center {
            flex: 2;
            text-align: center;
        }
        
        .hud-right {
            flex: 1;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .game-btn {
            padding: 8px 12px;
            font-size: 16px;
            min-width: auto;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            transition: all 0.2s ease;
        }
        
        .game-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .game-btn:active {
            transform: scale(0.95);
        }
        
        .score {
            font-size: 20px;
        }
        
        .energy-container {
            display: flex;
            align-items: center;
        }
        
        .energy-label {
            margin-right: 10px;
        }
        
        .energy-bar {
            width: 100px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            overflow: hidden;
            margin-right: 10px;
        }
        
        .energy-fill {
            height: 100%;
            background-color: #FFD700;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .character {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 600px) {
            .screen-content {
                max-width: 90%;
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- å¼€å§‹å±å¹• -->
        <div id="startScreen" class="screen">
            <div class="screen-content">
                <h1>ã€Šå¤§åœ£è·‘é…·ã€‹</h1>
                <div>
                    <img id="heroImage" src="https://p26-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/150f260467d64ef9b931785b4b4133b5.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251211152212F67DEB15F1C7AF8E9FF8&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1766042533&x-signature=2EMdIJM94B9e74fq%2FqQXJZY8XvM%3D" alt="é½å¤©å¤§åœ£" class="character" style="width: 220px; height: 220px;">
                </div>
                <div class="main-menu-buttons">
                    <button id="startBtn" class="btn">å¼€å§‹æ¸¸æˆ</button>
                    <button id="achievementsBtn" class="btn">ğŸ† æˆå°±</button>
                    <button id="settingsBtn" class="btn">âš™ï¸ è®¾ç½®</button>
                    <button id="rulesBtn" class="btn-secondary">ğŸ“– æ¸¸æˆè§„åˆ™</button>
                </div>
            </div>
        </div>
        
        <!-- è§„åˆ™å±å¹• -->
        <div id="rulesScreen" class="screen hidden">
            <div class="screen-content">
                <h2 style="color: #fff;">æ¸¸æˆè§„åˆ™</h2>
                <ul style="color: #e0e0e0;">
                    <li>ç‚¹å‡»å±å¹•è·³è·ƒï¼Œå†æ¬¡ç‚¹å‡»è¿›è¡ŒäºŒæ®µè·³</li>
                    <li>æ”¶é›†å°æ¡ƒå­è·å¾—1åˆ†ï¼Œå¤§æ¡ƒå­è·å¾—5åˆ†</li>
                    <li>æ”¶é›†100ç§¯åˆ†å¯è·å¾—ä¸€æ¬¡ç­‹æ–—äº‘å†²åˆº</li>
                    <li>ç­‹æ–—äº‘å†²åˆºæœŸé—´æ— æ•Œï¼Œè‡ªåŠ¨å‰è¿›10ç§’</li>
                    <li>è·Œè½äº‘å±‚ç¼éš™å³å¤±è´¥</li>
                    <li>æ¸¸æˆé€Ÿåº¦ä¼šéšæ—¶é—´å¢åŠ ï¼ŒæŒ‘æˆ˜ä½ çš„ååº”èƒ½åŠ›</li>
                </ul>
                <button id="backToStartBtn" class="btn">è¿”å›</button>
            </div>
        </div>
        
        <!-- è®¾ç½®å±å¹• -->
        <div id="settingsScreen" class="screen hidden">
            <div class="screen-content">
                <h2>âš™ï¸ è®¾ç½®</h2>
                <div class="settings-options" style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px;">
                    <div class="setting-item" style="display: flex; align-items: center; justify-content: space-between; width: 200px; color: #fff;">
                        <label for="soundToggle" style="color: #fff;">éŸ³æ•ˆ</label>
                        <label class="toggle">
                            <input type="checkbox" id="soundToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; align-items: center; justify-content: space-between; width: 200px; color: #fff;">
                        <label for="musicToggle" style="color: #fff;">èƒŒæ™¯éŸ³ä¹</label>
                        <label class="toggle">
                            <input type="checkbox" id="musicToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; align-items: center; justify-content: space-between; width: 200px; color: #fff;">
                        <label for="vibrationToggle" style="color: #fff;">éœ‡åŠ¨åé¦ˆ</label>
                        <label class="toggle">
                            <input type="checkbox" id="vibrationToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-actions" style="display: flex; justify-content: center;">
                    <button id="backToMenuFromSettingsBtn" class="btn">è¿”å›</button>
                </div>
            </div>
        </div>
        
        <!-- æ¸¸æˆç•Œé¢ HUD -->
        <div id="gameHUD" class="hud hidden">
            <div class="hud-left">
                <div class="score">åˆ†æ•°: <span id="scoreDisplay">0</span></div>
            </div>
            <div class="hud-center">
                <div class="energy-container">
                    <span class="energy-label">ç­‹æ–—äº‘:</span>
                    <div class="energy-bar">
                        <div id="energyFill" class="energy-fill"></div>
                    </div>
                    <button id="dashBtn" class="btn game-btn" disabled>å†²åˆº</button>
                </div>
            </div>
            <div class="hud-right">
                <button id="pauseBtn" class="btn game-btn">â¸ï¸</button>
                <button id="gameSettingsBtn" class="btn game-btn">âš™ï¸</button>
            </div>
        </div>
        
        <!-- æš‚åœå±å¹• -->
        <div id="pauseScreen" class="screen hidden">
            <div class="screen-content">
                <h2>æ¸¸æˆæš‚åœ</h2>
                <button id="resumeBtn" class="btn">ç»§ç»­æ¸¸æˆ</button>
                <button id="restartBtn" class="btn-secondary">é‡æ–°å¼€å§‹</button>
                <button id="exitBtn" class="btn">é€€å‡ºæ¸¸æˆ</button>
            </div>
        </div>
        
        <!-- ç»“æŸå±å¹• -->
        <div id="gameOverScreen" class="screen hidden">
            <div class="screen-content">
                <h2>æ¸¸æˆç»“æŸ</h2>
                <p style="text-align: center; color: #e0e0e0;">ä½ çš„å¾—åˆ†</p>
                <p style="font-size: 32px; color: #FFD700; margin: 10px 0; text-align: center;">
                    <span id="finalScore">0</span>
                </p>
                <div style="text-align: center;">
                    <p style="color: #e0e0e0;">æœ€é«˜åˆ†</p>
                    <p style="font-size: 24px; margin: 10px 0; color: #e0e0e0;">
                        <span id="highScore">0</span>
                    </p>
                </div>
                <button id="playAgainBtn" class="btn">å†ç©ä¸€æ¬¡</button>
                <button id="shareBtn" class="btn-secondary">åˆ†äº«æˆç»©</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆå¸¸é‡
        const GAME_WIDTH = 800;
        const GAME_HEIGHT = 600;
        const GRAVITY = 800;
        const JUMP_FORCE = 400;
        const DOUBLE_JUMP_FORCE = 350;
        const MAX_FALL_SPEED = 500;
        const INITIAL_SPEED = 150;
        const MAX_SPEED = 350;
        const SPEED_UP_DURATION = 150;
        const DASH_SPEED = 500;
        const DASH_DURATION = 5;
        const DASH_COST = 20;
        const PLATFORM_WIDTH = 64;
        const PLATFORM_HEIGHT = 32;
        const PLAYER_WIDTH = 64;
        const PLAYER_HEIGHT = 64;
        const PEACH_SCORE = 1;
        const BIG_PEACH_SCORE = 5;
        
        // æˆå°±ç³»ç»Ÿå¸¸é‡
        const ACHIEVEMENTS = {
            PEACH_COLLECTOR: {
                id: 'peach_collector',
                name: 'æ”¶é›†è¾¾äºº',
                description: 'æ”¶é›†æ¡ƒå­',
                levels: [
                    { requirement: 100, reward: 'åˆå‡ºèŒ…åº' },
                    { requirement: 500, reward: 'å°æœ‰æˆå°±' },
                    { requirement: 1000, reward: 'æ¡ƒå­å¤§å¸ˆ' }
                ],
                icon: 'ğŸ‘'
            },
            LONG_RUNNER: {
                id: 'long_runner',
                name: 'é•¿è·‘å¥å°†',
                description: 'æ¸¸æˆæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰',
                levels: [
                    { requirement: 1, reward: 'çƒ­èº«å®Œæ¯•' },
                    { requirement: 5, reward: 'æ¸å…¥ä½³å¢ƒ' },
                    { requirement: 10, reward: 'é©¬æ‹‰æ¾é€‰æ‰‹' }
                ],
                icon: 'â±ï¸'
            },
            HIGH_SCORER: {
                id: 'high_scorer',
                name: 'é«˜åˆ†ç‹è€…',
                description: 'è·å¾—é«˜åˆ†',
                levels: [
                    { requirement: 1000, reward: 'åˆéœ²é”‹èŠ’' },
                    { requirement: 5000, reward: 'å®åŠ›éå‡¡' },
                    { requirement: 10000, reward: 'æ–—æˆ˜èƒœä½›' }
                ],
                icon: 'ğŸ†'
            },
            DASH_MASTER: {
                id: 'dash_master',
                name: 'å†²åˆºå¤§å¸ˆ',
                description: 'ä½¿ç”¨ç­‹æ–—äº‘',
                levels: [
                    { requirement: 10, reward: 'åˆå­¦ä¹ç»ƒ' },
                    { requirement: 50, reward: 'è…¾äº‘é©¾é›¾' },
                    { requirement: 100, reward: 'ç­‹æ–—äº‘ä¸“å®¶' }
                ],
                icon: 'â˜ï¸'
            },
            JUMP_EXPERT: {
                id: 'jump_expert',
                name: 'è·³è·ƒä¸“å®¶',
                description: 'è¿ç»­è·³è·ƒ',
                levels: [
                    { requirement: 100, reward: 'è·ƒè·ƒæ¬²è¯•' },
                    { requirement: 300, reward: 'èº«è½»å¦‚ç‡•' },
                    { requirement: 500, reward: 'è…¾è·ƒå¦‚é£' }
                ],
                icon: 'ğŸ¦˜'
            }
        };
        
        // æ¸¸æˆçŠ¶æ€
        const GAME_STATE = {
            MENU: 'menu',
            PLAYING: 'playing',
            PAUSED: 'paused',
            GAME_OVER: 'gameOver'
        };
        
        // ç©å®¶çŠ¶æ€
        const PLAYER_STATE = {
            IDLE: 'idle',
            RUNNING: 'running',
            JUMPING: 'jumping',
            DOUBLE_JUMPING: 'doubleJumping',
            DASHING: 'dashing',
            FALLING: 'falling',
            DEAD: 'dead'
        };
        
        // æ¸¸æˆå¯¹è±¡
        let canvas, ctx;
        let gameState = GAME_STATE.MENU;
        let score = 0;
        let highScore = 0;
        let gameSpeed = INITIAL_SPEED;
        let gameTime = 0;
        let lastTime = 0;
        let dashEnergy = 0;
        let isDashing = false;
        let dashTime = 0;
        let platforms = [];
        let peaches = [];
        let bigPeaches = [];
        let particles = [];
        let keys = {};
        let touchStartY = 0;
        let gameLoopId = null;
        
        // æˆå°±ç³»ç»Ÿå˜é‡
        let achievements = {};
        let stats = {
            totalPeaches: 0,
            totalPlayTime: 0,
            totalDashes: 0,
            currentJumpStreak: 0,
            maxJumpStreak: 0
        };
        let newlyUnlockedAchievements = [];
        
        // èµ„æºåŠ è½½
        const images = {};
        const sounds = {};
        
        // ç®€åŒ–ç‰ˆæœ¬ - ä¸ä½¿ç”¨åŠ¨ç”»ç³»ç»Ÿ
        
        // ç©å®¶å¯¹è±¡
        const player = {
            x: 100,
            y: GAME_HEIGHT / 2,
            width: PLAYER_WIDTH,
            height: PLAYER_HEIGHT,
            velocityY: 0,
            isOnGround: false,
            hasDoubleJumped: false,
            state: PLAYER_STATE.IDLE,
            animationFrame: 0,
            animationTime: 0,
            animationSpeed: 0.1, // åŠ¨ç”»é€Ÿåº¦

            
            update: function(deltaTime) {
                if (this.state === PLAYER_STATE.DEAD) return;
                
                // å†²åˆºæ—¶ä¸å—é‡åŠ›å½±å“ï¼Œä¿æŒé£è¡ŒçŠ¶æ€
                if (!isDashing) {
                    // åº”ç”¨é‡åŠ›
                    this.velocityY += GRAVITY * deltaTime;
                    if (this.velocityY > MAX_FALL_SPEED) {
                        this.velocityY = MAX_FALL_SPEED;
                    }
                } else {
                    // å†²åˆºæ—¶ä¿æŒåœ¨å›ºå®šé«˜åº¦ï¼Œä¸å‘ä¸Šé£˜
                    this.velocityY = 0;
                }
                
                // æ›´æ–°ä½ç½®
                this.y += this.velocityY * deltaTime;
                
                // æ›´æ–°åŠ¨ç”»
                this.animationTime += deltaTime;
                if (this.animationTime >= this.animationSpeed) {
                    // ä½¿ç”¨3å¸§åŠ¨ç”»
                    this.animationFrame = (this.animationFrame + 1) % 3;
                    this.animationTime = 0;
                }
                
                // æ›´æ–°çŠ¶æ€
                if (isDashing) {
                    this.state = PLAYER_STATE.DASHING;
                } else if (this.velocityY < 0) {
                    this.state = this.hasDoubleJumped ? PLAYER_STATE.DOUBLE_JUMPING : PLAYER_STATE.JUMPING;
                } else if (this.velocityY > 50) {
                    this.state = PLAYER_STATE.FALLING;
                } else if (this.isOnGround) {
                    this.state = PLAYER_STATE.RUNNING;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ‰è½ï¼ˆå†²åˆºæ—¶ä¸ä¼šæ‰è½ï¼‰
                if (!isDashing && this.y > GAME_HEIGHT) {
                    gameOver();
                }
            },
            

            
            jump: function() {
                if (this.state === PLAYER_STATE.DEAD || isDashing) return;
                
                if (this.isOnGround) {
                    this.velocityY = -JUMP_FORCE;
                    this.isOnGround = false;
                    this.hasDoubleJumped = false;
                    this.state = PLAYER_STATE.JUMPING;
                    playSound('jump');
                    
                    // é‡ç½®è·³è·ƒè¿å‡»
                    stats.currentJumpStreak = 1;
                } else if (!this.hasDoubleJumped) {
                    this.velocityY = -DOUBLE_JUMP_FORCE;
                    this.hasDoubleJumped = true;
                    this.state = PLAYER_STATE.DOUBLE_JUMPING;
                    playSound('doubleJump');
                    
                    // å¢åŠ è·³è·ƒè¿å‡»
                    stats.currentJumpStreak++;
                    if (stats.currentJumpStreak > stats.maxJumpStreak) {
                        stats.maxJumpStreak = stats.currentJumpStreak;
                    }
                    
                    // æ£€æŸ¥è·³è·ƒä¸“å®¶æˆå°±
                    checkAchievements();
                }
            },
            
            dash: function() {
                if (dashEnergy >= DASH_COST && !isDashing) {
                    isDashing = true;
                    dashTime = DASH_DURATION;
                    dashEnergy -= DASH_COST;
                    this.state = PLAYER_STATE.DASHING;
                    playSound('dash');
                    updateDashEnergy();
                    
                    // æ›´æ–°å†²åˆºç»Ÿè®¡
                    stats.totalDashes++;
                    
                    // æ£€æŸ¥å†²åˆºå¤§å¸ˆæˆå°±
                    checkAchievements();
                }
            },
            
            draw: function() {
                ctx.save();
                
                // å†²åˆºæ—¶çš„ç‰¹æ•ˆ
                if (isDashing) {
                    ctx.globalAlpha = 0.8;
                    ctx.shadowColor = '#FFD700';
                    ctx.shadowBlur = 15;
                }
                
                // æ ¹æ®åŠ¨ç”»å¸§é€‰æ‹©å¯¹åº”çš„ç©å®¶å›¾ç‰‡
                let playerImage;
                switch(this.animationFrame) {
                    case 0:
                        playerImage = images.player1;
                        break;
                    case 1:
                        playerImage = images.player2;
                        break;
                    case 2:
                        playerImage = images.player3;
                        break;
                    default:
                        playerImage = images.player1;
                }
                
                // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦åŠ è½½å®Œæˆ
                if (!playerImage || !playerImage.complete) {
                    // å¦‚æœå›¾ç‰‡æœªåŠ è½½å®Œæˆï¼Œç»˜åˆ¶ä¸€ä¸ªå ä½æ–¹å—
                    ctx.fillStyle = '#FF4500';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.restore();
                    return;
                }
                
                try {
                    // ç»˜åˆ¶ç©å®¶å›¾ç‰‡
                    ctx.drawImage(
                        playerImage,
                        this.x, this.y, this.width, this.height
                    );
                } catch (error) {
                    console.error('ç»˜åˆ¶è§’è‰²æ—¶å‡ºé”™:', error);
                    // å‡ºé”™æ—¶ç»˜åˆ¶å ä½æ–¹å—
                    ctx.fillStyle = '#FF4500';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }
                
                ctx.restore();
            }
        };
        
        // æˆå°±ç³»ç»ŸåŠŸèƒ½
        function loadAchievements() {
            try {
                const savedAchievements = localStorage.getItem('dasheng-achievements');
                if (savedAchievements) {
                    achievements = JSON.parse(savedAchievements);
                }
                
                const savedStats = localStorage.getItem('dasheng-stats');
                if (savedStats) {
                    stats = JSON.parse(savedStats);
                }
            } catch (error) {
                console.error('åŠ è½½æˆå°±æ•°æ®å¤±è´¥:', error);
                achievements = {};
                stats = {
                    totalPeaches: 0,
                    totalPlayTime: 0,
                    totalDashes: 0,
                    currentJumpStreak: 0,
                    maxJumpStreak: 0
                };
            }
        }
        
        function saveAchievements() {
            try {
                localStorage.setItem('dasheng-achievements', JSON.stringify(achievements));
                localStorage.setItem('dasheng-stats', JSON.stringify(stats));
            } catch (error) {
                console.error('ä¿å­˜æˆå°±æ•°æ®å¤±è´¥:', error);
            }
        }
        
        function checkAchievements() {
            const unlockedThisTime = [];
            
            // æ£€æŸ¥æ”¶é›†è¾¾äººæˆå°±
            const peachCollector = checkAchievementLevel(
                ACHIEVEMENTS.PEACH_COLLECTOR,
                stats.totalPeaches
            );
            if (peachCollector) unlockedThisTime.push(peachCollector);
            
            // æ£€æŸ¥é•¿è·‘å¥å°†æˆå°±
            const longRunner = checkAchievementLevel(
                ACHIEVEMENTS.LONG_RUNNER,
                Math.floor(stats.totalPlayTime / 60) // è½¬æ¢ä¸ºåˆ†é’Ÿ
            );
            if (longRunner) unlockedThisTime.push(longRunner);
            
            // æ£€æŸ¥é«˜åˆ†ç‹è€…æˆå°±
            const highScorer = checkAchievementLevel(
                ACHIEVEMENTS.HIGH_SCORER,
                score
            );
            if (highScorer) unlockedThisTime.push(highScorer);
            
            // æ£€æŸ¥å†²åˆºå¤§å¸ˆæˆå°±
            const dashMaster = checkAchievementLevel(
                ACHIEVEMENTS.DASH_MASTER,
                stats.totalDashes
            );
            if (dashMaster) unlockedThisTime.push(dashMaster);
            
            // æ£€æŸ¥è·³è·ƒä¸“å®¶æˆå°±
            const jumpExpert = checkAchievementLevel(
                ACHIEVEMENTS.JUMP_EXPERT,
                stats.maxJumpStreak
            );
            if (jumpExpert) unlockedThisTime.push(jumpExpert);
            
            // ä¿å­˜æ–°è§£é”çš„æˆå°±
            if (unlockedThisTime.length > 0) {
                newlyUnlockedAchievements = unlockedThisTime;
                saveAchievements();
                showAchievementNotifications();
            }
        }
        
        function checkAchievementLevel(achievement, currentValue) {
            if (!achievements[achievement.id]) {
                achievements[achievement.id] = 0;
            }
            
            const currentLevel = achievements[achievement.id];
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è§£é”æ›´é«˜ç­‰çº§
            for (let i = achievement.levels.length - 1; i >= currentLevel; i--) {
                if (currentValue >= achievement.levels[i].requirement) {
                    if (i > currentLevel) {
                        achievements[achievement.id] = i + 1; // ç­‰çº§ä»1å¼€å§‹
                        return {
                            achievement: achievement,
                            level: i,
                            previousLevel: currentLevel
                        };
                    }
                    break;
                }
            }
            
            return null;
        }
        
        function showAchievementNotifications() {
            // ç§»é™¤ç°æœ‰çš„é€šçŸ¥
            const existingNotifications = document.querySelectorAll('.achievement-notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            // æ˜¾ç¤ºæ–°é€šçŸ¥
            newlyUnlockedAchievements.forEach((unlock, index) => {
                setTimeout(() => {
                    const notification = document.createElement('div');
                    notification.className = 'achievement-notification';
                    notification.innerHTML = `
                        <div class="notification-content">
                            <div class="notification-icon">${unlock.achievement.icon}</div>
                            <div class="notification-text">
                                <div class="notification-title">æˆå°±è§£é”ï¼</div>
                                <div class="notification-name">${unlock.achievement.name}</div>
                                <div class="notification-reward">${unlock.achievement.levels[unlock.level].reward}</div>
                            </div>
                        </div>
                    `;
                    
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #FFD700, #FFA500);
                        border-radius: 10px;
                        padding: 15px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        z-index: 1000;
                        transform: translateX(400px);
                        transition: transform 0.5s ease;
                        max-width: 300px;
                    `;
                    
                    const style = document.createElement('style');
                    style.textContent = `
                        .notification-content {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .notification-icon {
                            font-size: 32px;
                        }
                        .notification-text {
                            flex: 1;
                        }
                        .notification-title {
                            font-weight: bold;
                            color: #8B4513;
                        }
                        .notification-name {
                            font-size: 14px;
                            color: #333;
                        }
                        .notification-reward {
                            font-size: 12px;
                            color: #666;
                            font-style: italic;
                        }
                    `;
                    
                    document.head.appendChild(style);
                    document.body.appendChild(notification);
                    
                    // åŠ¨ç”»æ˜¾ç¤º
                    setTimeout(() => {
                        notification.style.transform = 'translateX(0)';
                    }, 100);
                    
                    // 3ç§’åéšè—
                    setTimeout(() => {
                        notification.style.transform = 'translateX(400px)';
                        setTimeout(() => {
                            notification.remove();
                        }, 500);
                    }, 3000);
                }, index * 1000); // æ¯ç§’æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥
            });
        }
        
        function showAchievementsScreen() {
            const achievementsScreen = document.createElement('div');
            achievementsScreen.id = 'achievementsScreen';
            achievementsScreen.className = 'screen';
            
            let achievementsHTML = `
                <div class="screen-content" style="max-height: 80vh; overflow-y: auto;">
                    <h2>ğŸ† æˆå°±</h2>
                    <div class="achievements-list">
            `;
            
            // è®¡ç®—æ€»æˆå°±è¿›åº¦
            let totalLevels = 0;
            let unlockedLevels = 0;
            
            // ç”Ÿæˆæ¯ä¸ªæˆå°±çš„HTML
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                const currentLevel = achievements[achievement.id] || 0;
                totalLevels += achievement.levels.length;
                unlockedLevels += currentLevel;
                
                achievementsHTML += `
                    <div class="achievement-item">
                        <div class="achievement-header">
                            <span class="achievement-icon">${achievement.icon}</span>
                            <span class="achievement-name">${achievement.name}</span>
                            <span class="achievement-progress">${currentLevel}/${achievement.levels.length}</span>
                        </div>
                        <div class="achievement-levels">
                `;
                
                achievement.levels.forEach((level, index) => {
                    const isUnlocked = currentLevel > index;
                    achievementsHTML += `
                        <div class="achievement-level ${isUnlocked ? 'unlocked' : 'locked'}">
                            <div class="level-icon">${isUnlocked ? 'âœ“' : 'ğŸ”’'}</div>
                            <div class="level-info">
                                <div class="level-reward">${level.reward}</div>
                                <div class="level-requirement">${level.requirement}</div>
                            </div>
                        </div>
                    `;
                });
                
                achievementsHTML += `
                        </div>
                    </div>
                `;
            });
            
            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            const progressPercentage = Math.round((unlockedLevels / totalLevels) * 100);
            achievementsHTML += `
                    </div>
                    <div class="overall-progress">
                        <h3>æ€»ä½“è¿›åº¦</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="progress-text">${unlockedLevels}/${totalLevels}</div>
                    </div>
                    <div class="stats-summary">
                        <div class="stat-item">ğŸ‘ æ¡ƒå­: ${stats.totalPeaches}</div>
                        <div class="stat-item">â±ï¸ æ¸¸æˆæ—¶é—´: ${Math.floor(stats.totalPlayTime / 60)}åˆ†${stats.totalPlayTime % 60}ç§’</div>
                        <div class="stat-item">â˜ï¸ ç­‹æ–—äº‘: ${stats.totalDashes}</div>
                    </div>
                    <button class="btn close-achievements">å…³é—­</button>
                </div>
            `;
            
            achievementsHTML += `
                </div>
            `;
            
            achievementsScreen.innerHTML = achievementsHTML;
            
            // æ·»åŠ æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .achievements-list {
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                    margin: 20px 0;
                }
                .achievement-item {
                    background: white;
                    border-radius: 8px;
                    padding: 15px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .achievement-header {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 5px;
                }
                .achievement-icon {
                    font-size: 24px;
                }
                .achievement-name {
                    flex: 1;
                    font-weight: bold;
                    color: #000;
                }
                .achievement-progress {
                    background: #f0f0f0;
                    padding: 2px 8px;
                    border-radius: 10px;
                    font-size: 12px;
                }
                .achievement-description {
                    color: #333;
                    font-size: 14px;
                    margin-bottom: 10px;
                }
                .achievement-levels {
                    display: flex;
                    flex-direction: column;
                    gap: 5px;
                }
                .achievement-level {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 8px;
                    border-radius: 5px;
                    background: #f9f9f9;
                }
                .achievement-level.unlocked {
                    background: #e8f5e8;
                    border: 1px solid #4CAF50;
                }
                .achievement-level.locked {
                    opacity: 0.6;
                }
                .level-icon {
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    background: #ddd;
                }
                .achievement-level.unlocked .level-icon {
                    background: #4CAF50;
                    color: white;
                }
                .level-info {
                    flex: 1;
                }
                .level-reward {
                    font-weight: bold;
                    font-size: 14px;
                }
                .level-requirement {
                    font-size: 12px;
                    color: #666;
                }
                .overall-progress {
                    margin: 20px 0;
                }
                .progress-bar {
                    width: 100%;
                    height: 20px;
                    background: #f0f0f0;
                    border-radius: 10px;
                    overflow: hidden;
                    margin: 10px 0;
                }
                .progress-fill {
                    height: 100%;
                    background: linear-gradient(90deg, #FFD700, #FFA500);
                    transition: width 0.3s ease;
                }
                .stats-summary {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 20px 0;
                }
                .stat-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 5px 0;
                    border-bottom: 1px solid #eee;
                }
                .stat-item:last-child {
                    border-bottom: none;
                }
            `;
            document.head.appendChild(style);
            
            // æ·»åŠ åˆ°DOMå¹¶æ˜¾ç¤º
            document.getElementById('game-container').appendChild(achievementsScreen);
            
            // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
            achievementsScreen.querySelector('.close-achievements').addEventListener('click', () => {
                achievementsScreen.remove();
            });
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function init() {
            console.log('åˆå§‹åŒ–æ¸¸æˆ');
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // åŠ è½½æˆå°±æ•°æ®
            loadAchievements();
            
            // åŠ è½½èµ„æº
            loadResources();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬
            setupEventListeners();
            
            // åŠ è½½æœ€é«˜åˆ†
            highScore = localStorage.getItem('dasheng-highscore') || 0;
            document.getElementById('highScore').textContent = highScore;
            
            // æ˜¾ç¤ºå¼€å§‹å±å¹•
            showScreen('startScreen');
        }
        
        // è°ƒæ•´ç”»å¸ƒå°ºå¯¸
        function resizeCanvas() {
            const container = document.getElementById('game-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // ä¿æŒæ¸¸æˆæ¯”ä¾‹
            const gameRatio = GAME_WIDTH / GAME_HEIGHT;
            let newWidth, newHeight;
            
            if (containerWidth / containerHeight > gameRatio) {
                newHeight = containerHeight;
                newWidth = newHeight * gameRatio;
            } else {
                newWidth = containerWidth;
                newHeight = newWidth / gameRatio;
            }
            
            canvas.width = GAME_WIDTH;
            canvas.height = GAME_HEIGHT;
            canvas.style.width = `${newWidth}px`;
            canvas.style.height = `${newHeight}px`;
        }
        
        // åŠ è½½æ¸¸æˆèµ„æº
        function loadResources() {
            console.log('åŠ è½½æ¸¸æˆèµ„æº');
            
            // æ˜¾ç¤ºåŠ è½½è¿›åº¦
            const loadingScreen = document.createElement('div');
            loadingScreen.id = 'loadingScreen';
            loadingScreen.className = 'screen';
            loadingScreen.innerHTML = `
                <div class="screen-content">
                    <h2>åŠ è½½ä¸­...</h2>
                    <div style="width: 200px; height: 20px; background-color: #ddd; border-radius: 10px; margin: 20px 0;">
                        <div id="loadingBar" style="height: 100%; background-color: #FF4500; width: 0%; border-radius: 10px; transition: width 0.3s ease;"></div>
                    </div>
                    <p id="loadingText">æ­£åœ¨åŠ è½½æ¸¸æˆèµ„æº...</p>
                </div>
            `;
            document.getElementById('game-container').appendChild(loadingScreen);
            
            // å›¾ç‰‡èµ„æº
            const imageSources = {
                player1: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/f8c2adb7d9f44c8983c66342bcea006e.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251212092936DD4506079B266A10AE2F&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1766107777&x-signature=csfJSC6D860qXlyvVkQx5kTwAak%3D',
                player2: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/2773235cdb3c4ea88e1dfcc68f08aab2.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251212092936DD4506079B266A10AE2F&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1766107777&x-signature=jtDWJUedfSSuep%2BWy6yit6k2%2Fpo%3D',
                player3: 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/eebfb4cf17854796b61a2b5ef4fcaf34.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251212092936DD4506079B266A10AE2F&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1766107777&x-signature=HDoNLm5xrGwf0hdjgtBWg%2BcfUAk%3D',
                platform: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/1a41f4732a7c4646b0d0580e0d9f1366~tplv-a9rns2rl98-image.image?rcl=202512111550474CA02A6DDEAED8BF0310&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768031603&x-signature=qPjZ4h5wxeAKqul6jPhZytOpnHg%3D',
                peach: 'https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/ef68e526ccc34136b0434da1b4b10fa7~tplv-a9rns2rl98-image.image?rcl=202512111550474CA02A6DDEAED8BF0310&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768031614&x-signature=H7FTrkTAj6sbz6r3QrYPmPwrb1U%3D',
                bigPeach: 'https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/ef68e526ccc34136b0434da1b4b10fa7~tplv-a9rns2rl98-image.image?rcl=202512111550474CA02A6DDEAED8BF0310&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768031614&x-signature=H7FTrkTAj6sbz6r3QrYPmPwrb1U%3D',
                background: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/077d3a6a04e1450d92800a6afa778c94.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251212093207CD6EAD894CA80A59E343&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1766107927&x-signature=1OPMIDIvJuTNFiEVB1awNoc5HUE%3D'
            };
            
            // é¢„åŠ è½½å›¾ç‰‡ï¼Œä½¿ç”¨Imageå¯¹è±¡çš„decode()æ–¹æ³•æé«˜åŠ è½½æ€§èƒ½
            const preloadedImages = {};
            const loadPromises = [];
            
            for (const [key, src] of Object.entries(imageSources)) {
                const img = new Image();
                img.src = src;
                preloadedImages[key] = img;
                
                const promise = new Promise((resolve, reject) => {
                    img.onload = () => {
                        console.log(`åŠ è½½å›¾ç‰‡: ${key}`);
                        resolve(key);
                    };
                    img.onerror = () => {
                        console.error(`åŠ è½½å›¾ç‰‡å¤±è´¥: ${key}`);
                        reject(key);
                    };
                });
                
                loadPromises.push(promise);
            }
            
            // ç›‘æ§åŠ è½½è¿›åº¦
            let loadedImages = 0;
            const totalImages = Object.keys(imageSources).length;
            
            Promise.allSettled(loadPromises).then(results => {
                results.forEach(result => {
                    if (result.status === 'fulfilled') {
                        loadedImages++;
                        images[result.value] = preloadedImages[result.value];
                    } else {
                        console.warn(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${result.reason}ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ˜¾ç¤º`);
                    }
                });
                
                // æ›´æ–°UIæ˜¾ç¤º
                updateLoadingProgress(loadedImages / totalImages * 100);
                document.getElementById('loadingText').textContent = `å›¾ç‰‡èµ„æºåŠ è½½å®Œæˆ (${loadedImages}/${totalImages})`;
                
                console.log('å›¾ç‰‡èµ„æºåŠ è½½å®Œæˆ');
                setTimeout(() => {
                    // ç§»é™¤åŠ è½½å±å¹•
                    if (loadingScreen.parentNode) {
                        loadingScreen.parentNode.removeChild(loadingScreen);
                    }
                }, 500);
            });
            
            // æ›´æ–°åŠ è½½è¿›åº¦æ¡
            function updateLoadingProgress(percentage) {
                const loadingBar = document.getElementById('loadingBar');
                if (loadingBar) {
                    loadingBar.style.width = `${percentage}%`;
                }
            }
            
            // éŸ³æ•ˆèµ„æº (ä½¿ç”¨Web Audio APIåˆ›å»ºç®€å•çš„éŸ³æ•ˆ)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // åˆ›å»ºéŸ³æ•ˆå‡½æ•°
                function createSound(frequency, duration, type = 'sine') {
                    return function() {
                        try {
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.value = frequency;
                            oscillator.type = type;
                            
                            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                            
                            oscillator.start(audioContext.currentTime);
                            oscillator.stop(audioContext.currentTime + duration);
                        } catch (e) {
                            console.error('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e);
                        }
                    };
                }
                
                // åˆ›å»ºéŸ³æ•ˆ
                sounds.jump = createSound(440, 0.1);
                sounds.doubleJump = createSound(660, 0.15);
                sounds.collect = createSound(880, 0.1);
                sounds.bigCollect = createSound(1000, 0.2, 'square');
                sounds.dash = createSound(220, 0.3, 'sawtooth');
                sounds.gameOver = createSound(110, 0.5, 'triangle');
                
                console.log('éŸ³æ•ˆèµ„æºå·²åˆ›å»º');
            } catch (e) {
                console.warn('Web Audio APIä¸å—æ”¯æŒï¼Œæ— æ³•æ’­æ”¾éŸ³æ•ˆ:', e);
                // åˆ›å»ºç©ºå‡½æ•°ä½œä¸ºå›é€€
                sounds.jump = sounds.doubleJump = sounds.collect = sounds.bigCollect = sounds.dash = sounds.gameOver = () => {};
            }
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            console.log('è®¾ç½®äº‹ä»¶ç›‘å¬');
            
            // é”®ç›˜äº‹ä»¶
            window.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (gameState === GAME_STATE.PLAYING) {
                        player.jump();
                    }
                } else if (e.code === 'KeyP' && gameState === GAME_STATE.PLAYING) {
                    togglePause();
                } else if (e.code === 'KeyR' && gameState === GAME_STATE.GAME_OVER) {
                    startGame();
                }
            });
            
            window.addEventListener('keyup', (e) => {
                keys[e.code] = false;
            });
            
            // è§¦æ‘¸äº‹ä»¶
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchStartY = e.touches[0].clientY;
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
            });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (gameState === GAME_STATE.PLAYING) {
                    player.jump();
                } else if (gameState === GAME_STATE.MENU) {
                    // åœ¨èœå•çŠ¶æ€ä¸‹ï¼Œç‚¹å‡»ç”»å¸ƒä¹Ÿå¯ä»¥å¼€å§‹æ¸¸æˆ
                    const target = e.target;
                    if (target === canvas || target.closest('.screen')) {
                        startGame();
                    }
                }
            });
            
            // ç‚¹å‡»äº‹ä»¶
            canvas.addEventListener('click', (e) => {
                if (gameState === GAME_STATE.PLAYING) {
                    player.jump();
                }
            });
            
            // æŒ‰é’®äº‹ä»¶ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
            document.addEventListener('click', (e) => {
                const id = e.target.id;
                console.log('ç‚¹å‡»å…ƒç´ ID:', id);
                
                // å¼€å§‹å±å¹•æŒ‰é’®
                if (id === 'startBtn') {
                    startGame();
                } else if (id === 'rulesBtn') {
                    showScreen('rulesScreen');
                } else if (id === 'achievementsBtn') {
                    showAchievementsScreen();
                } else if (id === 'settingsBtn') {
                    showScreen('settingsScreen');
                }
                
                // è§„åˆ™å±å¹•æŒ‰é’®
                else if (id === 'backToStartBtn') {
                    showScreen('startScreen');
                }
                
                // è®¾ç½®å±å¹•æŒ‰é’®
                else if (id === 'backToMenuFromSettingsBtn') {
                    showScreen('startScreen');
                } else if (id === 'resetProgressBtn') {
                    resetProgress();
                }
                
                // æš‚åœå±å¹•æŒ‰é’®
                else if (id === 'resumeBtn') {
                    togglePause();
                } else if (id === 'restartBtn') {
                    startGame();
                } else if (id === 'exitBtn') {
                    gameState = GAME_STATE.MENU;
                    showScreen('startScreen');
                    hideElement('gameHUD');
                }
                
                // ç»“æŸå±å¹•æŒ‰é’®
                else if (id === 'playAgainBtn') {
                    console.log('ç‚¹å‡»å†ç©ä¸€æ¬¡æŒ‰é’®');
                    startGame();
                } else if (id === 'shareBtn') {
                    shareScore();
                }
                
                // æ¸¸æˆä¸­æŒ‰é’®
                else if (id === 'dashBtn' && gameState === GAME_STATE.PLAYING) {
                    player.dash();
                } else if (id === 'pauseBtn' && gameState === GAME_STATE.PLAYING) {
                    togglePause();
                } else if (id === 'gameSettingsBtn' && gameState === GAME_STATE.PLAYING) {
                    // å…ˆæš‚åœæ¸¸æˆï¼Œå†æ˜¾ç¤ºè®¾ç½®
                    togglePause();
                    showScreen('settingsScreen');
                }
            });
        }
        
        // æ˜¾ç¤ºæŒ‡å®šå±å¹•
        function showScreen(screenId) {
            console.log('æ˜¾ç¤ºå±å¹•:', screenId);
            // éšè—æ‰€æœ‰å±å¹•
            const screens = ['startScreen', 'rulesScreen', 'pauseScreen', 'gameOverScreen', 'settingsScreen'];
            screens.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            // æ˜¾ç¤ºæŒ‡å®šå±å¹•
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
            }
        }
        
        // æ˜¾ç¤ºå…ƒç´ 
        function showElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('hidden');
            }
        }
        
        // éšè—å…ƒç´ 
        function hideElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('hidden');
            }
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            console.log('å¼€å§‹æ¸¸æˆ');
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState = GAME_STATE.PLAYING;
            score = 0;
            gameSpeed = INITIAL_SPEED;
            gameTime = 0;
            dashEnergy = 0;
            isDashing = false;
            dashTime = 0;
            platforms = [];
            peaches = [];
            bigPeaches = [];
            particles = [];
            
            // é‡ç½®ç©å®¶
            player.x = 100;
            player.y = GAME_HEIGHT / 2;
            player.velocityY = 0;
            player.isOnGround = false;
            player.hasDoubleJumped = false;
            player.state = PLAYER_STATE.RUNNING;
            
            // ç”Ÿæˆåˆå§‹å¹³å°
            generateInitialPlatforms();
            
            // æ›´æ–°UI
            document.getElementById('scoreDisplay').textContent = '0';
            updateDashEnergy();
            showElement('gameHUD');
            hideElement('startScreen');
            hideElement('pauseScreen');
            hideElement('gameOverScreen');
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
            }
            lastTime = 0;
            gameLoopId = requestAnimationFrame(gameLoop);
            
            console.log('æ¸¸æˆå·²å¼€å§‹');
        }
        
        // ç”Ÿæˆåˆå§‹å¹³å°
        function generateInitialPlatforms() {
            // æ¸…ç©ºç°æœ‰å¹³å°
            platforms = [];
            
            // ç”Ÿæˆèµ·å§‹å¹³å°
            platforms.push({
                x: 0,
                y: GAME_HEIGHT / 2 + 50,
                width: PLATFORM_WIDTH * 3,
                height: PLATFORM_HEIGHT
            });
            
            // ç”Ÿæˆåç»­å¹³å°
            let lastX = platforms[0].x + platforms[0].width;
            let lastY = platforms[0].y;
            
            for (let i = 0; i < 20; i++) {
                // éšæœºå¹³å°å®½åº¦
                const width = PLATFORM_WIDTH * (Math.random() > 0.7 ? 2 : 1);
                
                // éšæœºé—´éš™
                const gap = PLATFORM_WIDTH * (1 + Math.random() * 2);
                
                // éšæœºYåç§»
                const yOffset = (Math.random() - 0.5) * PLATFORM_HEIGHT * 3;
                const y = Math.max(PLATFORM_HEIGHT * 2, Math.min(GAME_HEIGHT - PLATFORM_HEIGHT * 2, lastY + yOffset));
                
                platforms.push({
                    x: lastX + gap,
                    y: y,
                    width: width,
                    height: PLATFORM_HEIGHT
                });
                
                lastX = platforms[platforms.length - 1].x + platforms[platforms.length - 1].width;
                lastY = y;
                
                // éšæœºç”Ÿæˆæ¡ƒå­ - æ¦‚ç‡æé«˜ä¸€å€
                if (Math.random() > 0.35) {
                    generatePeach(platforms[platforms.length - 1].x + platforms[platforms.length - 1].width / 2 - PLATFORM_WIDTH / 4, platforms[platforms.length - 1].y);
                }
                
                // éšæœºç”Ÿæˆå¤§æ¡ƒå­ - æ¦‚ç‡æé«˜ä¸€å€
                if (Math.random() > 0.90) {
                    generateBigPeach(platforms[platforms.length - 1].x + platforms[platforms.length - 1].width / 2 - PLATFORM_WIDTH / 2, platforms[platforms.length - 1].y);
                }
            }
        }
        
        // ç”Ÿæˆå¹³å°
        function generatePlatform(x) {
            // éšæœºå¹³å°å®½åº¦
            const width = PLATFORM_WIDTH * (Math.random() > 0.7 ? 2 : 1);
            
            // éšæœºé—´éš™
            const gap = PLATFORM_WIDTH * (1 + Math.random() * 2);
            
            // è·å–æœ€åä¸€ä¸ªå¹³å°çš„ä½ç½®
            const lastPlatform = platforms[platforms.length - 1];
            const lastY = lastPlatform.y;
            
            // éšæœºYåç§»
            const yOffset = (Math.random() - 0.5) * PLATFORM_HEIGHT * 3;
            const y = Math.max(PLATFORM_HEIGHT * 2, Math.min(GAME_HEIGHT - PLATFORM_HEIGHT * 2, lastY + yOffset));
            
            platforms.push({
                x: x + gap,
                y: y,
                width: width,
                height: PLATFORM_HEIGHT
            });
            
            return platforms[platforms.length - 1];
        }
        
        // ç”Ÿæˆæ¡ƒå­
        function generatePeach(x, y) {
            peaches.push({
                x: x,
                y: y - PLATFORM_HEIGHT,
                width: PLATFORM_WIDTH / 2,
                height: PLATFORM_WIDTH / 2,
                collected: false
            });
        }
        
        // ç”Ÿæˆå¤§æ¡ƒå­
        function generateBigPeach(x, y) {
            bigPeaches.push({
                x: x,
                y: y - PLATFORM_HEIGHT * 1.5,
                width: PLATFORM_WIDTH,
                height: PLATFORM_WIDTH,
                collected: false,
                pulseTime: 0
            });
        }
        
        // æ¸¸æˆæ€§èƒ½ä¼˜åŒ–
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let currentFps = 0;
        const targetFPS = 60;
        const frameInterval = 1000 / targetFPS;
        let lastFrameTime = 0;
        
        // æ¸¸æˆå¾ªç¯
        function gameLoop(timestamp) {
            // å¸§ç‡æ§åˆ¶
            if (timestamp - lastFrameTime < frameInterval) {
                gameLoopId = requestAnimationFrame(gameLoop);
                return;
            }
            
            // è®¡ç®—æ—¶é—´å¢é‡
            if (!lastTime) lastTime = timestamp;
            const deltaTime = Math.min((timestamp - lastTime) / 1000, 0.1);
            lastTime = timestamp;
            lastFrameTime = timestamp;
            
            // è®¡ç®—FPS
            frameCount++;
            if (timestamp - lastFpsUpdate >= 1000) {
                currentFps = Math.round(frameCount * 1000 / (timestamp - lastFpsUpdate));
                frameCount = 0;
                lastFpsUpdate = timestamp;
            }
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            if (gameState === GAME_STATE.PLAYING) {
                update(deltaTime);
            }
            
            // æ¸²æŸ“æ¸¸æˆ
            render();
            
            // æ˜¾ç¤ºFPSï¼ˆè°ƒè¯•ç”¨ï¼‰
            if (currentFps < 30) {
                console.warn(`ä½å¸§ç‡è­¦å‘Š: ${currentFps} FPS`);
            }
            
            // ç»§ç»­æ¸¸æˆå¾ªç¯
            if (gameState === GAME_STATE.PLAYING) {
                gameLoopId = requestAnimationFrame(gameLoop);
            }
        }
        
        // æ›´æ–°æ¸¸æˆé€»è¾‘
        function update(deltaTime) {
            // æ›´æ–°æ¸¸æˆæ—¶é—´
            gameTime += deltaTime;
            
            // æ›´æ–°æ¸¸æˆé€Ÿåº¦
            if (gameTime < SPEED_UP_DURATION) {
                // çº¿æ€§å¢é•¿é€Ÿåº¦
                gameSpeed = INITIAL_SPEED + (MAX_SPEED - INITIAL_SPEED) * (gameTime / SPEED_UP_DURATION);
            } else {
                gameSpeed = MAX_SPEED;
            }
            
            // æ›´æ–°å†²åˆºçŠ¶æ€
            if (isDashing) {
                dashTime -= deltaTime;
                if (dashTime <= 0) {
                    isDashing = false;
                    player.state = PLAYER_STATE.RUNNING;
                    
                    // å†²åˆºç»“æŸæ—¶åœ¨è§’è‰²è„šä¸‹ç”Ÿæˆäº‘æœµå¹³å°
                    const cloudPlatform = {
                        x: player.x - PLATFORM_WIDTH,
                        y: player.y + player.height,
                        width: PLATFORM_WIDTH * 3,
                        height: PLATFORM_HEIGHT,
                        isCloud: true, // æ ‡è®°ä¸ºäº‘æœµå¹³å°
                        lifeTime: 3 // äº‘æœµå¹³å°æŒç»­3ç§’
                    };
                    platforms.push(cloudPlatform);
                    
                    // æ’­æ”¾ç€é™†éŸ³æ•ˆ
                    playSound('jump');
                }
            }
            
            // æ›´æ–°ç©å®¶
            player.update(deltaTime);
            
            // æ›´æ–°å¹³å°
            updatePlatforms(deltaTime);
            
            // æ›´æ–°æ¡ƒå­
            updatePeaches(deltaTime);
            
            // æ£€æµ‹ç¢°æ’
            checkCollisions();
        }
        
        // æ›´æ–°å¹³å°
        function updatePlatforms(deltaTime) {
            const speed = isDashing ? DASH_SPEED : gameSpeed;
            
            // ç§»åŠ¨å¹³å°
            for (let i = platforms.length - 1; i >= 0; i--) {
                const platform = platforms[i];
                
                // æ›´æ–°äº‘æœµå¹³å°ç”Ÿå‘½å‘¨æœŸ
                if (platform.isCloud) {
                    platform.lifeTime -= deltaTime;
                    if (platform.lifeTime <= 0) {
                        platforms.splice(i, 1);
                        continue;
                    }
                    
                    // äº‘æœµå¹³å°ä¸éšæ¸¸æˆç§»åŠ¨ï¼Œä¿æŒåœ¨åŸåœ°
                    continue;
                }
                
                platform.x -= speed * deltaTime;
                
                // ç§»é™¤å±å¹•å¤–çš„å¹³å°
                if (platform.x + platform.width < 0) {
                    platforms.splice(i, 1);
                }
            }
            
            // ç”Ÿæˆæ–°å¹³å°
            const lastPlatform = platforms[platforms.length - 1];
            if (lastPlatform && lastPlatform.x + lastPlatform.width < GAME_WIDTH + 200) {
                const newPlatform = generatePlatform(lastPlatform.x + lastPlatform.width);
                
                // éšæœºç”Ÿæˆæ¡ƒå­ - æ¦‚ç‡æé«˜ä¸€å€
                if (Math.random() > 0.35) {
                    generatePeach(newPlatform.x + newPlatform.width / 2 - PLATFORM_WIDTH / 4, newPlatform.y);
                }
                
                // éšæœºç”Ÿæˆå¤§æ¡ƒå­ - æ¦‚ç‡æé«˜ä¸€å€
                if (Math.random() > 0.90) {
                    generateBigPeach(newPlatform.x + newPlatform.width / 2 - PLATFORM_WIDTH / 2, newPlatform.y);
                }
            }
        }
        
        // æ›´æ–°æ¡ƒå­
        function updatePeaches(deltaTime) {
            const speed = isDashing ? DASH_SPEED : gameSpeed;
            
            // ç§»åŠ¨å°æ¡ƒå­
            for (let i = peaches.length - 1; i >= 0; i--) {
                const peach = peaches[i];
                
                if (isDashing) {
                    // å†²åˆºæ—¶çš„ç£é“åŠŸèƒ½ - å¢å¼ºç‰ˆ
                    const magnetForce = 500; // ç£é“å¸å¼•åŠ›ï¼ˆå¢å¼ºï¼‰
                    const magnetRange = 400; // ç£é“ä½œç”¨èŒƒå›´ï¼ˆæ‰©å¤§ï¼‰
                    
                    // è®¡ç®—æ¡ƒå­åˆ°ç©å®¶çš„è·ç¦»
                    const dx = player.x - peach.x;
                    const dy = player.y - peach.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < magnetRange && !peach.collected) {
                        // è®¡ç®—å¸å¼•åŠ›æ–¹å‘
                        const angle = Math.atan2(dy, dx);
                        const forceX = Math.cos(angle) * magnetForce * deltaTime;
                        const forceY = Math.sin(angle) * magnetForce * deltaTime;
                        
                        // åº”ç”¨å¸å¼•åŠ›
                        peach.x += forceX;
                        peach.y += forceY;
                        
                        // æ·»åŠ ç£é“æ•ˆæœçš„è§†è§‰åé¦ˆ
                        peach.magnetEffect = true;
                    }
                }
                
                // æ­£å¸¸ç§»åŠ¨
                peach.x -= speed * deltaTime;
                
                // ç§»é™¤å±å¹•å¤–çš„æ¡ƒå­
                if (peach.x + peach.width < 0) {
                    peaches.splice(i, 1);
                }
            }
            
            // ç§»åŠ¨å¤§æ¡ƒå­
            for (let i = bigPeaches.length - 1; i >= 0; i--) {
                const bigPeach = bigPeaches[i];
                
                if (isDashing) {
                    // å†²åˆºæ—¶çš„ç£é“åŠŸèƒ½å¯¹å¤§æ¡ƒå­åŒæ ·æœ‰æ•ˆ - å¢å¼ºç‰ˆ
                    const magnetForce = 450; // ç£é“å¸å¼•åŠ›ï¼ˆå¢å¼ºï¼‰
                    const magnetRange = 450; // ç£é“ä½œç”¨èŒƒå›´ï¼ˆæ‰©å¤§ï¼‰
                    
                    // è®¡ç®—å¤§æ¡ƒå­åˆ°ç©å®¶çš„è·ç¦»
                    const dx = player.x - bigPeach.x;
                    const dy = player.y - bigPeach.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < magnetRange && !bigPeach.collected) {
                        // è®¡ç®—å¸å¼•åŠ›æ–¹å‘
                        const angle = Math.atan2(dy, dx);
                        const forceX = Math.cos(angle) * magnetForce * deltaTime;
                        const forceY = Math.sin(angle) * magnetForce * deltaTime;
                        
                        // åº”ç”¨å¸å¼•åŠ›
                        bigPeach.x += forceX;
                        bigPeach.y += forceY;
                        
                        // æ·»åŠ ç£é“æ•ˆæœçš„è§†è§‰åé¦ˆ
                        bigPeach.magnetEffect = true;
                    }
                }
                
                // æ­£å¸¸ç§»åŠ¨
                bigPeach.x -= speed * deltaTime;
                bigPeach.pulseTime += deltaTime;
                
                // ç§»é™¤å±å¹•å¤–çš„å¤§æ¡ƒå­
                if (bigPeach.x + bigPeach.width < 0) {
                    bigPeaches.splice(i, 1);
                }
            }
        }
        
        // æ£€æµ‹ç¢°æ’ - ä¼˜åŒ–ç‰ˆæœ¬
        function checkCollisions() {
            // å¹³å°ç¢°æ’
            player.isOnGround = false;
            
            // å†²åˆºæ—¶ä¸è¿›è¡Œå¹³å°ç¢°æ’æ£€æµ‹ï¼Œå®ç°æ— æ•Œé£è¡Œ
            if (!isDashing) {
                // ä½¿ç”¨è¾¹ç•Œæ¡†ä¼˜åŒ–ç¢°æ’æ£€æµ‹
                const playerBottom = player.y + player.height;
                const playerRight = player.x + player.width;
                
                // åªæ£€æŸ¥å±å¹•å†…çš„å¹³å°
                for (let i = 0; i < platforms.length; i++) {
                    const platform = platforms[i];
                    
                    // å¿«é€Ÿæ’é™¤æ˜æ˜¾ä¸ç¢°æ’çš„æƒ…å†µ
                    if (playerRight < platform.x || player.x > platform.x + platform.width) {
                        continue;
                    }
                    
                    if (
                        playerRight > platform.x &&
                        player.x < platform.x + platform.width &&
                        playerBottom > platform.y &&
                        playerBottom < platform.y + 20 &&
                        player.velocityY > 0
                    ) {
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.isOnGround = true;
                        player.hasDoubleJumped = false;
                        break; // åªå¤„ç†ä¸€ä¸ªå¹³å°ç¢°æ’
                    }
                }
            }
            
            // æ¡ƒå­ç¢°æ’æ£€æµ‹ä¼˜åŒ–
            let collectedPeaches = 0;
            let collectedBigPeaches = 0;
            
            // å°æ¡ƒå­ç¢°æ’
            for (let i = peaches.length - 1; i >= 0; i--) {
                const peach = peaches[i];
                
                if (!peach.collected &&
                    player.x + player.width > peach.x &&
                    player.x < peach.x + peach.width &&
                    player.y + player.height > peach.y &&
                    player.y < peach.y + peach.height) {
                    
                    peach.collected = true;
                    collectedPeaches++;
                }
            }
            
            // å¤§æ¡ƒå­ç¢°æ’
            for (let i = bigPeaches.length - 1; i >= 0; i--) {
                const bigPeach = bigPeaches[i];
                
                if (!bigPeach.collected &&
                    player.x + player.width > bigPeach.x &&
                    player.x < bigPeach.x + bigPeach.width &&
                    player.y + player.height > bigPeach.y &&
                    player.y < bigPeach.y + bigPeach.height) {
                    
                    bigPeach.collected = true;
                    collectedBigPeaches++;
                }
            }
            
            // æ‰¹é‡æ›´æ–°åˆ†æ•°å’Œèƒ½é‡
            if (collectedPeaches > 0 || collectedBigPeaches > 0) {
                // å†²åˆºæ—¶èŸ æ¡ƒæ•°é‡å¢åŠ ä¸‰å€
                const scoreMultiplier = isDashing ? 3 : 1;
                
                // åŸºç¡€èƒ½é‡å€¼ï¼ˆä¸è€ƒè™‘å€æ•°ï¼‰
                const baseEnergy = collectedPeaches * PEACH_SCORE + collectedBigPeaches * BIG_PEACH_SCORE;
                // åˆ†æ•°è€ƒè™‘å€æ•°
                const totalScore = baseEnergy * scoreMultiplier;
                
                // èƒ½é‡å€¼å§‹ç»ˆæ­£å¸¸ç§¯ç´¯ï¼Œä¸å—å†²åˆºå€æ•°å½±å“
                const totalEnergy = baseEnergy;
                
                score += totalScore;
                dashEnergy += totalEnergy;
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                stats.totalPeaches += collectedPeaches + collectedBigPeaches;
                
                document.getElementById('scoreDisplay').textContent = score;
                updateDashEnergy();
                
                // æ’­æ”¾éŸ³æ•ˆ
                if (collectedBigPeaches > 0) {
                    playSound('bigCollect');
                } else if (collectedPeaches > 0) {
                    playSound('collect');
                }
                
                // æ£€æŸ¥æˆå°±
                checkAchievements();
            }
            
            // ç§»é™¤å·²æ”¶é›†çš„æ¡ƒå­ï¼ˆæ‰¹é‡æ“ä½œï¼‰
            if (collectedPeaches > 0) {
                peaches = peaches.filter(peach => !peach.collected);
            }
            if (collectedBigPeaches > 0) {
                bigPeaches = bigPeaches.filter(bigPeach => !bigPeach.collected);
            }
        }
        
        // æ›´æ–°ç­‹æ–—äº‘èƒ½é‡
        function updateDashEnergy() {
            const percentage = Math.min(100, (dashEnergy / DASH_COST) * 100);
            document.getElementById('energyFill').style.width = `${percentage}%`;
            document.getElementById('dashBtn').disabled = dashEnergy < DASH_COST;
        }
        
        // æ¸²æŸ“æ¸¸æˆ
        function render() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            if (images.background) {
                ctx.drawImage(images.background, 0, 0, GAME_WIDTH, GAME_HEIGHT);
            } else {
                // å¤‡ç”¨èƒŒæ™¯
                ctx.fillStyle = '#0f3460';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            }
            
            // ç»˜åˆ¶å¹³å°
            for (const platform of platforms) {
                ctx.save();
                
                if (platform.isCloud) {
                    // äº‘æœµå¹³å°ç‰¹æ®Šæ•ˆæœ
                    ctx.globalAlpha = 0.8;
                    ctx.shadowColor = '#FFFFFF';
                    ctx.shadowBlur = 10;
                    
                    if (images.platform) {
                        // ä½¿ç”¨å¹³å°å›¾ç‰‡ä½†æ·»åŠ äº‘æœµæ•ˆæœ
                        ctx.drawImage(
                            images.platform,
                            platform.x,
                            platform.y,
                            platform.width,
                            platform.height
                        );
                        
                        // æ·»åŠ äº‘æœµçº¹ç†
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                        ctx.beginPath();
                        ctx.arc(platform.x + platform.width * 0.25, platform.y + platform.height * 0.5, platform.height * 0.3, 0, Math.PI * 2);
                        ctx.arc(platform.x + platform.width * 0.5, platform.y + platform.height * 0.3, platform.height * 0.4, 0, Math.PI * 2);
                        ctx.arc(platform.x + platform.width * 0.75, platform.y + platform.height * 0.5, platform.height * 0.3, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        // å¤‡ç”¨äº‘æœµå¹³å°
                        ctx.fillStyle = '#E8F4FD';
                        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    }
                } else if (images.platform) {
                    // æ™®é€šå¹³å°
                    ctx.drawImage(
                        images.platform,
                        platform.x,
                        platform.y,
                        platform.width,
                        platform.height
                    );
                } else {
                    // å¤‡ç”¨æ™®é€šå¹³å°
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                }
                
                ctx.restore();
            }
            
            // ç»˜åˆ¶æ¡ƒå­
            for (const peach of peaches) {
                // ç£é“æ•ˆæœçš„è§†è§‰åé¦ˆ
                if (peach.magnetEffect) {
                    ctx.save();
                    // æ·»åŠ å‘å…‰æ•ˆæœ
                    ctx.shadowColor = '#FFD700';
                    ctx.shadowBlur = 15;
                    
                    // æ·»åŠ ç²’å­æ•ˆæœ
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.6)';
                    ctx.beginPath();
                    ctx.arc(peach.x + peach.width / 2, peach.y + peach.height / 2, peach.width / 2 + 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
                
                if (images.peach) {
                    ctx.drawImage(
                        images.peach,
                        peach.x,
                        peach.y,
                        peach.width,
                        peach.height
                    );
                } else {
                    // å¤‡ç”¨æ¡ƒå­
                    ctx.fillStyle = '#FF6347';
                    ctx.beginPath();
                    ctx.arc(peach.x + peach.width / 2, peach.y + peach.height / 2, peach.width / 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // ç»˜åˆ¶å¤§æ¡ƒå­
            for (const bigPeach of bigPeaches) {
                // ç£é“æ•ˆæœçš„è§†è§‰åé¦ˆ
                if (bigPeach.magnetEffect) {
                    ctx.save();
                    // æ·»åŠ å‘å…‰æ•ˆæœ
                    ctx.shadowColor = '#FFD700';
                    ctx.shadowBlur = 20;
                    
                    // æ·»åŠ ç²’å­æ•ˆæœ
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
                    ctx.beginPath();
                    ctx.arc(bigPeach.x + bigPeach.width / 2, bigPeach.y + bigPeach.height / 2, bigPeach.width / 2 + 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
                
                // å¤§æ¡ƒå­è„‰å†²æ•ˆæœ
                const pulse = 1 + 0.1 * Math.sin(bigPeach.pulseTime * 10);
                
                ctx.save();
                ctx.translate(
                    bigPeach.x + bigPeach.width / 2,
                    bigPeach.y + bigPeach.height / 2
                );
                ctx.scale(pulse, pulse);
                
                if (images.bigPeach) {
                    ctx.drawImage(
                        images.bigPeach,
                        -bigPeach.width / 2,
                        -bigPeach.height / 2,
                        bigPeach.width,
                        bigPeach.height
                    );
                } else {
                    // å¤‡ç”¨å¤§æ¡ƒå­
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(0, 0, bigPeach.width / 2, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
            }
            
            // ç»˜åˆ¶ç©å®¶
            if (images.player1) {
                player.draw();
            } else {
                // å¤‡ç”¨ç©å®¶
                ctx.fillStyle = '#FF4500';
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }
        }
        
        // åˆ‡æ¢æš‚åœçŠ¶æ€
        function togglePause() {
            if (gameState === GAME_STATE.PLAYING) {
                gameState = GAME_STATE.PAUSED;
                showScreen('pauseScreen');
                if (gameLoopId) {
                    cancelAnimationFrame(gameLoopId);
                    gameLoopId = null;
                }
            } else if (gameState === GAME_STATE.PAUSED) {
                gameState = GAME_STATE.PLAYING;
                hideElement('pauseScreen');
                lastTime = 0;
                gameLoopId = requestAnimationFrame(gameLoop);
            }
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver() {
            console.log('æ¸¸æˆç»“æŸ');
            gameState = GAME_STATE.GAME_OVER;
            player.state = PLAYER_STATE.DEAD;
            playSound('gameOver');
            
            // åœæ­¢æ¸¸æˆå¾ªç¯
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            
            // æ›´æ–°æ¸¸æˆæ—¶é—´ç»Ÿè®¡
            stats.totalPlayTime += Math.floor(gameTime);
            
            // æ£€æŸ¥æˆå°±
            checkAchievements();
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('dasheng-highscore', highScore);
            }
            
            // ä¿å­˜æˆå°±æ•°æ®
            saveAchievements();
            
            // æ›´æ–°UI
            document.getElementById('finalScore').textContent = score;
            document.getElementById('highScore').textContent = highScore;
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸå±å¹•
            showScreen('gameOverScreen');
            hideElement('gameHUD');
            
            // æ˜¾ç¤ºæ–°è§£é”çš„æˆå°±
            if (newlyUnlockedAchievements.length > 0) {
                setTimeout(() => {
                    showAchievementNotifications();
                }, 1000);
            }
            
            console.log('æ¸¸æˆç»“æŸå±å¹•å·²æ˜¾ç¤º');
        }
        
        // åˆ†äº«æˆç»©
        function shareScore() {
            console.log('åˆ†äº«æˆç»©:', score);
            // æ£€æŸ¥æ˜¯å¦åœ¨å¾®ä¿¡ç¯å¢ƒ
            if (typeof WeixinJSBridge !== 'undefined') {
                // å¾®ä¿¡åˆ†äº«
                WeixinJSBridge.invoke('shareTimeline', {
                    title: `æˆ‘åœ¨ã€Šå¤§åœ£é€ƒäº¡ã€‹ä¸­è·å¾—äº†${score}åˆ†ï¼`,
                    desc: 'å¿«æ¥æŒ‘æˆ˜æˆ‘ï¼Œçœ‹çœ‹è°èƒ½è·‘å¾—æ›´è¿œï¼',
                    link: window.location.href,
                    imgUrl: images.player ? images.player.src : ''
                });
            } else {
                // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(`${window.location.href}?score=${score}`)
                        .then(() => {
                            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ä»¥åˆ†äº«ç»™å¥½å‹äº†ï¼');
                        })
                        .catch(err => {
                            console.error('æ— æ³•å¤åˆ¶é“¾æ¥: ', err);
                            alert(`æˆ‘çš„å¾—åˆ†æ˜¯${score}åˆ†ï¼å¿«æ¥æŒ‘æˆ˜æˆ‘å§ï¼`);
                        });
                } else {
                    alert(`æˆ‘çš„å¾—åˆ†æ˜¯${score}åˆ†ï¼å¿«æ¥æŒ‘æˆ˜æˆ‘å§ï¼`);
                }
            }
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(soundName) {
            // æ£€æŸ¥éŸ³æ•ˆè®¾ç½®
            const soundEnabled = localStorage.getItem('dasheng-sound-enabled') !== 'false';
            if (!soundEnabled) return;
            
            if (sounds[soundName]) {
                try {
                    sounds[soundName]();
                } catch (e) {
                    console.error('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e);
                }
            }
        }
        
        // é‡ç½®æ¸¸æˆè¿›åº¦
        function resetProgress() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¸¸æˆè¿›åº¦å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æˆå°±å’Œæœ€é«˜åˆ†è®°å½•ã€‚')) {
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem('dasheng-highscore');
                localStorage.removeItem('dasheng-achievements');
                localStorage.removeItem('dasheng-stats');
                
                // é‡ç½®æ¸¸æˆæ•°æ®
                highScore = 0;
                achievements = {};
                stats = {
                    totalPeaches: 0,
                    totalPlayTime: 0,
                    totalDashes: 0,
                    currentJumpStreak: 0,
                    maxJumpStreak: 0
                };
                
                // æ›´æ–°UI
                document.getElementById('highScore').textContent = '0';
                
                alert('æ¸¸æˆè¿›åº¦å·²é‡ç½®ï¼');
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æ¸¸æˆ');
            init();
        });
        
        // é˜²æ­¢é¡µé¢æ»šåŠ¨
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>